<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bloc De Notas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <style>
        /* Custom styles if needed, e.g., for line-clamp */
        .line-clamp-3 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 3;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen p-4">
      <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
          <h1 class="text-3xl font-bold text-gray-900 mb-2">Bloc De Notas</h1>
          <p class="text-gray-600">Gestiona tus notas y cuentas de manera profesional</p>
        </div>

        <!-- Tabs -->
        <div class="flex space-x-1 mb-6">
          <button
            id="tab-notes"
            class="flex items-center px-4 py-2 rounded-lg font-medium transition-colors bg-blue-600 text-white"
          >
            <i data-lucide="file-text" class="w-4 h-4 mr-2"></i>
            Notas
          </button>
          <button
            id="tab-accounts"
            class="flex items-center px-4 py-2 rounded-lg font-medium transition-colors bg-white text-gray-600 hover:bg-gray-50"
          >
            <i data-lucide="calculator" class="w-4 h-4 mr-2"></i>
            Cuentas
          </button>
        </div>

        <!-- Content Area -->
        <div id="content-area">
            <!-- Notes Tab Content -->
            <div id="notes-section">
                <!-- Add Note Button -->
                <div class="mb-6">
                  <button
                    id="btn-add-note-form"
                    class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                  >
                    <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                    Nueva Nota
                  </button>
                </div>

                <!-- Add/Edit Note Form Container -->
                <div id="note-form-container" class="hidden bg-white rounded-lg shadow-sm p-6 mb-6">
                    <!-- Form will be injected here by JS -->
                </div>

                <!-- Notes List -->
                <div id="notes-list" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                  <!-- Notes will be injected here by JS -->
                </div>
            </div>

            <!-- Accounts Tab Content (Initially Hidden) -->
            <div id="accounts-section" class="hidden">
                <!-- Add Account Button -->
                <div class="mb-6">
                  <button
                    id="btn-add-account-form"
                    class="flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                  >
                    <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                    Nueva Cuenta
                  </button>
                </div>

                <!-- Add/Edit Account Form Container -->
                <div id="account-form-container" class="hidden bg-white rounded-lg shadow-sm p-6 mb-6">
                    <!-- Form will be injected here by JS -->
                </div>

                <!-- Accounts List -->
                <div id="accounts-list" class="space-y-4">
                  <!-- Accounts will be injected here by JS -->
                </div>
            </div>
        </div>
        
        <!-- Empty State Message -->
        <div id="empty-state" class="text-center py-12 hidden">
            <p class="text-gray-500">No hay <span id="empty-state-type">notas</span> aún. ¡Crea la primera!</p>
        </div>

      </div>
    </div>
    
    <script>
        // State Variables
        let activeTab = 'notes'; // 'notes' or 'accounts'
        
        // Notes State
        let notes = [];
        let isAddingNote = false;
        let editingNote = null; // Stores the note object being edited, or null
        let newNote = { title: '', content: '', category: 'general' };
        const categories = ['general', 'trabajo', 'personal', 'importante', 'ideas'];

        // Accounts State
        let accounts = [];
        let isAddingAccount = false;
        let editingAccount = null; // Stores the account object being edited, or null
        let newAccount = { 
            name: '', 
            totalDebt: 0, 
            totalPaid: 0, 
            description: '',
            payments: []
        };

        // DOM Elements (cache them for performance)
        const tabNotes = document.getElementById('tab-notes');
        const tabAccounts = document.getElementById('tab-accounts');
        const notesSection = document.getElementById('notes-section');
        const accountsSection = document.getElementById('accounts-section');
        
        const btnAddNoteForm = document.getElementById('btn-add-note-form');
        const noteFormContainer = document.getElementById('note-form-container');
        const notesList = document.getElementById('notes-list');
        
        const btnAddAccountForm = document.getElementById('btn-add-account-form');
        const accountFormContainer = document.getElementById('account-form-container');
        const accountsList = document.getElementById('accounts-list');

        const emptyState = document.getElementById('empty-state');
        const emptyStateType = document.getElementById('empty-state-type');

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCQ-G2ozgY7TJ6VxLn69y6PzagcOn2Qb6U",
            authDomain: "regiform-lkct3.firebaseapp.com",
            projectId: "regiform-lkct3",
            storageBucket: "regiform-lkct3.firebasestorage.app",
            messagingSenderId: "1028711119142",
            appId: "1:1028711119142:web:cfc2e2a9996f58ed4469e7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Lucide icon rendering function
        function renderLucideIcons() {
            lucide.createIcons();
        }

        // --- Core Logic Functions (Will be refactored for Firebase) ---

        // Notes Functions
        async function addNote() {
            if (newNote.title.trim() && newNote.content.trim()) {
                const noteToAdd = {
                    ...newNote, // title, content, category
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(), // Use Firestore server timestamp
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                try {
                    const docRef = await db.collection('notes').add(noteToAdd);
                    // Add to local state with Firestore-generated ID and resolved timestamps (or keep as is and re-fetch)
                    // For simplicity, we'll refetch or rely on Firestore's cache for updates.
                    // To show immediately, you might add a client-side version and then sync.
                    newNote = { title: '', content: '', category: 'general' };
                    isAddingNote = false;
                    await loadNotes(); // Reload notes from Firestore
                } catch (error) {
                    console.error("Error adding note: ", error);
                    renderApp(); // Still render to close form etc.
                }
            } else {
                renderApp(); // If validation fails, still ensure UI is consistent
            }
        }

        async function updateNote() {
            if (editingNote && editingNote.id && editingNote.title.trim() && editingNote.content.trim()) {
                const noteToUpdate = { 
                    title: editingNote.title,
                    content: editingNote.content,
                    category: editingNote.category,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                 }; 
                try {
                    await db.collection('notes').doc(editingNote.id).update(noteToUpdate);
                    editingNote = null;
                    await loadNotes(); // Reload notes from Firestore
                } catch (error) {
                    console.error("Error updating note: ", error);
                    renderApp(); // Render to reflect any UI changes even on error (e.g. keep form open)
                }
            } else {
                 renderApp();
            }
        }

        async function deleteNote(id) {
            if (!id) {
                console.error("DeleteNote: Invalid ID provided");
                return;
            }
            try {
                await db.collection('notes').doc(id).delete();
                if (editingNote && editingNote.id === id) {
                    editingNote = null; 
                }
                await loadNotes(); // Reload notes from Firestore
            } catch (error) {
                console.error("Error deleting note: ", error);
                renderApp(); // Re-render in case of error
            }
        }
        
        async function loadNotes() {
            try {
                const snapshot = await db.collection('notes').orderBy('updatedAt', 'desc').get();
                notes = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return { 
                        id: doc.id, 
                        ...data,
                        // Convert Firestore Timestamps to string for display if they exist
                        createdAt: data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString() : 'N/A',
                        updatedAt: data.updatedAt?.toDate ? data.updatedAt.toDate().toLocaleString() : 'N/A',
                    };
                });
            } catch (error) {
                console.error("Error loading notes: ", error);
                notes = []; 
            }
            renderApp(); // Always re-render after attempting to load notes
        }


        // Accounts Functions
        async function addAccount() {
            if (newAccount.name.trim()) {
                const accountToAdd = {
                    name: newAccount.name,
                    totalDebt: Number(newAccount.totalDebt) || 0,
                    totalPaid: Number(newAccount.totalPaid) || 0, // Should typically start at 0
                    description: newAccount.description || '',
                    payments: [], // Payments will be a subcollection or array within the doc
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                try {
                    await db.collection('accounts').add(accountToAdd);
                    newAccount = { name: '', totalDebt: 0, totalPaid: 0, description: '', payments: [] };
                    isAddingAccount = false;
                    await loadAccounts(); // Reload accounts
                } catch (error) {
                    console.error("Error adding account: ", error);
                    renderApp();
                }
            } else {
                renderApp();
            }
        }

        async function updateAccount() {
            if (editingAccount && editingAccount.id && editingAccount.name.trim()) {
                const accountToUpdate = {
                    name: editingAccount.name,
                    totalDebt: Number(editingAccount.totalDebt) || 0,
                    description: editingAccount.description || '',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    // totalPaid and payments are managed by addPayment/deletePayment
                };
                try {
                    await db.collection('accounts').doc(editingAccount.id).update(accountToUpdate);
                    editingAccount = null;
                    await loadAccounts(); // Reload accounts
                } catch (error) {
                    console.error("Error updating account: ", error);
                    renderApp();
                }
            } else {
                renderApp();
            }
        }

        async function deleteAccount(id) {
            if (!id) {
                console.error("DeleteAccount: Invalid ID provided");
                return;
            }
            try {
                await db.collection('accounts').doc(id).delete();
                if (editingAccount && editingAccount.id === id) {
                    editingAccount = null;
                }
                await loadAccounts(); // Reload accounts
            } catch (error) {
                console.error("Error deleting account: ", error);
                renderApp();
            }
        }

        async function addPayment(accountId, amountStr, description = '') {
            const amount = Number(amountStr);
            if (isNaN(amount) || amount <= 0 || !accountId) {
                console.error("AddPayment: Invalid amount or accountId", { accountId, amountStr, description });
                renderApp(); // re-render to clear inputs or show error if implemented
                return;
            }

            const accountRef = db.collection('accounts').doc(accountId);
            try {
                await db.runTransaction(async (transaction) => {
                    const accountDoc = await transaction.get(accountRef);
                    if (!accountDoc.exists) {
                        throw "Account document does not exist!";
                    }

                    const accountData = accountDoc.data();
                    const newPayment = {
                        id: Date.now().toString(), // Simple unique ID for payment
                        amount: amount,
                        description: description || '',
                        date: new Date().toLocaleString() // Storing as locale string, consider ISO or Timestamp for querying
                    };
                    
                    const newPayments = [...(accountData.payments || []), newPayment];
                    const newTotalPaid = (accountData.totalPaid || 0) + amount;

                    transaction.update(accountRef, {
                        payments: newPayments,
                        totalPaid: newTotalPaid,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                await loadAccounts(); // Reload to reflect changes
            } catch (error) {
                console.error("Error adding payment: ", error);
                renderApp();
            }
        }

        async function deletePayment(accountId, paymentId) {
            if (!accountId || !paymentId) {
                console.error("DeletePayment: Invalid accountId or paymentId");
                return;
            }
            const accountRef = db.collection('accounts').doc(accountId);
            try {
                await db.runTransaction(async (transaction) => {
                    const accountDoc = await transaction.get(accountRef);
                    if (!accountDoc.exists) {
                        throw "Account document does not exist!";
                    }
                    const accountData = accountDoc.data();
                    const paymentToDelete = (accountData.payments || []).find(p => p.id === paymentId);
                    if (!paymentToDelete) {
                        console.warn("Payment not found for deletion:", paymentId);
                        return; // Or throw error
                    }
                    const newPayments = (accountData.payments || []).filter(p => p.id !== paymentId);
                    const newTotalPaid = (accountData.totalPaid || 0) - paymentToDelete.amount;

                    transaction.update(accountRef, {
                        payments: newPayments,
                        totalPaid: newTotalPaid,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                await loadAccounts(); // Reload
            } catch (error) {
                console.error("Error deleting payment: ", error);
                renderApp();
            }
        }

        async function loadAccounts() {
            try {
                const snapshot = await db.collection('accounts').orderBy('updatedAt', 'desc').get();
                accounts = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return { 
                        id: doc.id, 
                        ...data,
                        // Ensure payments is an array
                        payments: data.payments || [],
                        // Convert Firestore Timestamps to string for display if they exist
                        createdAt: data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString() : 'N/A',
                        updatedAt: data.updatedAt?.toDate ? data.updatedAt.toDate().toLocaleString() : 'N/A',
                    };
                });
            } catch (error) {
                console.error("Error loading accounts: ", error);
                accounts = [];
            }
            renderApp(); // Always re-render after attempting to load accounts
        }

        // Helper Functions
        function getAccountStatus(account) {
            const remaining = (account.totalDebt || 0) - (account.totalPaid || 0);
            if (remaining <= 0) return 'paid';
            if ((account.totalPaid || 0) > 0) return 'partial';
            return 'pending';
        }

        function getCategoryColor(category) {
            const colors = {
                general: 'bg-gray-100 text-gray-800',
                trabajo: 'bg-blue-100 text-blue-800',
                personal: 'bg-green-100 text-green-800',
                importante: 'bg-red-100 text-red-800',
                ideas: 'bg-purple-100 text-purple-800'
            };
            return colors[category] || colors.general;
        }

        // --- Rendering Functions ---
        function renderApp() {
            renderTabs();
            renderNoteForm();
            renderNotes();
            renderAccountForm();
            renderAccounts();
            renderEmptyState();
            renderLucideIcons(); // Call after DOM manipulation to render new icons
        }
        
        function renderTabs() {
            if (activeTab === 'notes') {
                tabNotes.classList.add('bg-blue-600', 'text-white');
                tabNotes.classList.remove('bg-white', 'text-gray-600', 'hover:bg-gray-50');
                tabAccounts.classList.add('bg-white', 'text-gray-600', 'hover:bg-gray-50');
                tabAccounts.classList.remove('bg-blue-600', 'text-white');
                notesSection.classList.remove('hidden');
                accountsSection.classList.add('hidden');
            } else { // accounts tab
                tabAccounts.classList.add('bg-blue-600', 'text-white');
                tabAccounts.classList.remove('bg-white', 'text-gray-600', 'hover:bg-gray-50');
                tabNotes.classList.add('bg-white', 'text-gray-600', 'hover:bg-gray-50');
                tabNotes.classList.remove('bg-blue-600', 'text-white');
                accountsSection.classList.remove('hidden');
                notesSection.classList.add('hidden');
            }
        }

        function renderNoteForm() {
            if (isAddingNote || editingNote) {
                noteFormContainer.classList.remove('hidden');
                const currentData = editingNote || newNote;
                const isEditMode = !!editingNote;
                
                noteFormContainer.innerHTML = `
                    <h3 class="text-lg font-semibold mb-4">${isEditMode ? 'Editar Nota' : 'Nueva Nota'}</h3>
                    <div class="space-y-4">
                        <input
                            type="text"
                            id="note-title-input"
                            placeholder="Título de la nota"
                            value="${currentData.title}"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                        <select id="note-category-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            ${categories.map(cat => `<option value="${cat}" ${currentData.category === cat ? 'selected' : ''}>${cat.charAt(0).toUpperCase() + cat.slice(1)}</option>`).join('')}
                        </select>
                        <textarea
                            id="note-content-input"
                            placeholder="Contenido de la nota"
                            rows="6"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >${currentData.content}</textarea>
                        <div class="flex space-x-2">
                            <button id="btn-save-note" class="flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                <i data-lucide="save" class="w-4 h-4 mr-2"></i>Guardar
                            </button>
                            <button id="btn-cancel-note" class="flex items-center px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>Cancelar
                            </button>
                        </div>
                    </div>
                `;
                // Add event listeners for form elements
                document.getElementById('note-title-input').addEventListener('input', (e) => {
                    if (isEditMode) editingNote.title = e.target.value; else newNote.title = e.target.value;
                });
                document.getElementById('note-category-select').addEventListener('change', (e) => {
                    if (isEditMode) editingNote.category = e.target.value; else newNote.category = e.target.value;
                });
                document.getElementById('note-content-input').addEventListener('input', (e) => {
                    if (isEditMode) editingNote.content = e.target.value; else newNote.content = e.target.value;
                });
                document.getElementById('btn-save-note').addEventListener('click', () => {
                    if (isEditMode) updateNote(); else addNote();
                    renderApp(); // Re-render after action
                });
                document.getElementById('btn-cancel-note').addEventListener('click', () => {
                    isAddingNote = false;
                    editingNote = null;
                    renderApp(); // Re-render to hide form
                });

            } else {
                noteFormContainer.classList.add('hidden');
                noteFormContainer.innerHTML = '';
            }
        }

        function renderNotes() {
            notesList.innerHTML = ''; // Clear existing notes
            if (notes.length === 0 && activeTab === 'notes') {
                // Empty state handled by renderEmptyState
            } else {
                notes.forEach(note => {
                    const noteEl = document.createElement('div');
                    noteEl.className = 'bg-white rounded-lg shadow-sm p-4';
                    noteEl.innerHTML = `
                        ${editingNote && editingNote.id === note.id ? `
                            <div class="space-y-3">
                                <!-- Edit form is now part of renderNoteForm, this part might be simplified or removed if global form is always used -->
                                <!-- For inline editing, this would be different -->
                                <p class="text-sm text-gray-500">Editando... (Formulario arriba)</p>
                            </div>
                        ` : `
                            <div>
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="font-semibold text-gray-900">${note.title}</h3>
                                    <div class="flex space-x-1">
                                        <button data-note-id-edit="${note.id}" class="btn-edit-note p-1 text-gray-500 hover:text-blue-600">
                                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                                        </button>
                                        <button data-note-id-delete="${note.id}" class="btn-delete-note p-1 text-gray-500 hover:text-red-600">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                                <span class="inline-block px-2 py-1 rounded text-xs font-medium mb-2 ${getCategoryColor(note.category)}">
                                    ${note.category.charAt(0).toUpperCase() + note.category.slice(1)}
                                </span>
                                <p class="text-gray-700 text-sm mb-3 line-clamp-3">${note.content}</p>
                                <div class="text-xs text-gray-500">
                                    <p>Creado: ${note.createdAt}</p>
                                    ${note.updatedAt !== note.createdAt ? `<p>Actualizado: ${note.updatedAt}</p>` : ''}
                                </div>
                            </div>
                        `}
                    `;
                    notesList.appendChild(noteEl);
                });
            }
        }

        function renderAccountForm() {
            if (isAddingAccount || editingAccount) {
                accountFormContainer.classList.remove('hidden');
                const currentData = editingAccount || newAccount;
                const isEditMode = !!editingAccount;

                accountFormContainer.innerHTML = `
                    <h3 class="text-lg font-semibold mb-4">${isEditMode ? 'Editar Cuenta' : 'Nueva Cuenta'}</h3>
                    <div class="space-y-4">
                        <input
                            type="text"
                            id="account-name-input"
                            placeholder="Nombre de la cuenta"
                            value="${currentData.name}"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                        <input
                            type="number"
                            id="account-totaldebt-input"
                            placeholder="Total a deber"
                            value="${currentData.totalDebt}"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                        <textarea
                            id="account-description-input"
                            placeholder="Descripción (opcional)"
                            rows="3"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >${currentData.description}</textarea>
                        <div class="flex space-x-2">
                            <button id="btn-save-account" class="flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                <i data-lucide="save" class="w-4 h-4 mr-2"></i>Guardar
                            </button>
                            <button id="btn-cancel-account" class="flex items-center px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>Cancelar
                            </button>
                        </div>
                    </div>
                `;

                document.getElementById('account-name-input').addEventListener('input', (e) => {
                    if (isEditMode) editingAccount.name = e.target.value; else newAccount.name = e.target.value;
                });
                document.getElementById('account-totaldebt-input').addEventListener('input', (e) => {
                    const value = Number(e.target.value);
                    if (isEditMode) editingAccount.totalDebt = value; else newAccount.totalDebt = value;
                });
                document.getElementById('account-description-input').addEventListener('input', (e) => {
                    if (isEditMode) editingAccount.description = e.target.value; else newAccount.description = e.target.value;
                });
                 document.getElementById('btn-save-account').addEventListener('click', () => {
                    if (isEditMode) updateAccount(); else addAccount();
                    renderApp();
                });
                document.getElementById('btn-cancel-account').addEventListener('click', () => {
                    isAddingAccount = false;
                    editingAccount = null;
                    renderApp();
                });
            } else {
                accountFormContainer.classList.add('hidden');
                accountFormContainer.innerHTML = '';
            }
        }
        
        function renderAccounts() {
            accountsList.innerHTML = ''; // Clear existing accounts
            if (accounts.length === 0 && activeTab === 'accounts') {
                // Empty state handled by renderEmptyState
            } else {
                accounts.forEach(account => {
                    const accountCard = renderAccountCard(account);
                    accountsList.appendChild(accountCard);
                });
            }
        }

        // Holds the state for which account's payment history is shown
        let paymentHistoryVisibility = {}; 

        function renderAccountCard(account) {
            const cardEl = document.createElement('div');
            const status = getAccountStatus(account);
            const remaining = (account.totalDebt || 0) - (account.totalPaid || 0);

            const getStatusColorClasses = () => {
                switch (status) {
                    case 'paid': return 'bg-green-100 border-green-300 text-green-800';
                    case 'partial': return 'bg-yellow-100 border-yellow-300 text-yellow-800';
                    default: return 'bg-red-100 border-red-300 text-red-800';
                }
            };
            const getStatusText = () => {
                switch (status) {
                    case 'paid': return 'SALDADO';
                    case 'partial': return 'PARCIAL';
                    default: return 'PENDIENTE';
                }
            };

            cardEl.className = `bg-white rounded-lg shadow-sm border-2 ${getStatusColorClasses()}`;
            
            // Note: Editing form for accounts is handled by renderAccountForm, not inline here.
            // This simplifies logic, as the main form container is reused.
            cardEl.innerHTML = `
                <div class="p-6">
                    <div>
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-gray-900">${account.name}</h3>
                                <span class="inline-block px-3 py-1 rounded-full text-sm font-medium ${
                                    status === 'paid' ? 'bg-green-600 text-white' : 
                                    status === 'partial' ? 'bg-yellow-600 text-white' : 'bg-red-600 text-white'
                                }">
                                    ${getStatusText()}
                                </span>
                            </div>
                            <div class="flex space-x-2">
                                <button data-account-id-edit="${account.id}" class="btn-edit-account p-2 text-gray-500 hover:text-blue-600">
                                    <i data-lucide="edit-2" class="w-4 h-4"></i>
                                </button>
                                <button data-account-id-delete="${account.id}" class="btn-delete-account p-2 text-gray-500 hover:text-red-600">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>

                        ${account.description ? `<p class="text-gray-600 mb-4">${account.description}</p>` : ''}

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div class="text-center">
                                <p class="text-sm text-gray-500">Total a Deber</p>
                                <p class="text-lg font-bold text-gray-900">$${(account.totalDebt || 0).toFixed(2)}</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-500">Total Pagado</p>
                                <p class="text-lg font-bold text-blue-600">$${(account.totalPaid || 0).toFixed(2)}</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-500">Restante</p>
                                <p class="text-lg font-bold ${remaining <= 0 ? 'text-green-600' : 'text-red-600'}">
                                    $${Math.max(0, remaining).toFixed(2)}
                                </p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-500">Progreso</p>
                                <p class="text-lg font-bold text-purple-600">
                                    ${(account.totalDebt || 0) > 0 ? (((account.totalPaid || 0) / (account.totalDebt || 0)) * 100).toFixed(1) : 0}%
                                </p>
                            </div>
                        </div>

                        <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                            <div 
                                class="h-2 rounded-full transition-all duration-300 ${ status === 'paid' ? 'bg-green-600' : 'bg-blue-600' }"
                                style="width: ${(account.totalDebt || 0) > 0 ? Math.min(((account.totalPaid || 0) / (account.totalDebt || 0)) * 100, 100) : 0}%"
                            ></div>
                        </div>

                        <div class="border-t pt-4">
                            <div class="flex space-x-2 mb-4">
                                <input
                                    type="number"
                                    placeholder="Monto"
                                    id="payment-amount-${account.id}"
                                    class="flex-1 p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                />
                                <input
                                    type="text"
                                    placeholder="Descripción (opcional)"
                                    id="payment-description-${account.id}"
                                    class="flex-1 p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                />
                                <button data-account-id-addpayment="${account.id}" class="btn-add-payment flex items-center px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                                    <i data-lucide="dollar-sign" class="w-4 h-4 mr-1"></i>Pagar
                                </button>
                            </div>

                            <button data-account-id-togglepayments="${account.id}" class="btn-toggle-payments text-blue-600 hover:text-blue-800 text-sm font-medium">
                                ${paymentHistoryVisibility[account.id] ? 'Ocultar' : 'Ver'} Historial de Pagos (${(account.payments || []).length})
                            </button>

                            <div id="payments-history-${account.id}" class="mt-4 space-y-2 ${paymentHistoryVisibility[account.id] ? '' : 'hidden'}">
                                ${(account.payments && account.payments.length > 0) ? account.payments.map(payment => `
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                                        <div>
                                            <p class="font-medium">$${payment.amount.toFixed(2)}</p>
                                            ${payment.description ? `<p class="text-sm text-gray-600">${payment.description}</p>` : ''}
                                            <p class="text-xs text-gray-500">${payment.date}</p>
                                        </div>
                                        <button data-account-id-deletepayment="${account.id}" data-payment-id="${payment.id}" class="btn-delete-payment p-1 text-red-500 hover:text-red-700">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                `).join('') : '<p class="text-sm text-gray-500">No hay pagos registrados.</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            return cardEl;
        }

        function renderEmptyState() {
            const shouldShowEmptyState = (activeTab === 'notes' && notes.length === 0 && !isAddingNote && !editingNote) ||
                                       (activeTab === 'accounts' && accounts.length === 0 && !isAddingAccount && !editingAccount);
            if (shouldShowEmptyState) {
                emptyState.classList.remove('hidden');
                emptyStateType.textContent = activeTab === 'notes' ? 'notas' : 'cuentas';
            } else {
                emptyState.classList.add('hidden');
            }
        }


        // --- Event Listeners Setup ---
        function setupEventListeners() {
            // Tab switching
            tabNotes.addEventListener('click', () => {
                activeTab = 'notes';
                isAddingNote = false; // Close forms when switching tabs
                editingNote = null;
                renderApp();
            });
            tabAccounts.addEventListener('click', () => {
                activeTab = 'accounts';
                isAddingAccount = false; // Close forms when switching tabs
                editingAccount = null;
                renderApp();
            });

            // "Add New" buttons
            btnAddNoteForm.addEventListener('click', () => {
                isAddingNote = true;
                editingNote = null; // Ensure not in edit mode
                newNote = { title: '', content: '', category: 'general' }; // Reset newNote
                renderApp();
            });
            btnAddAccountForm.addEventListener('click', () => {
                isAddingAccount = true;
                editingAccount = null; // Ensure not in edit mode
                newAccount = { name: '', totalDebt: 0, totalPaid: 0, description: '', payments: [] }; // Reset newAccount
                renderApp();
            });

            // Event delegation for dynamic content (notes list)
            notesList.addEventListener('click', (e) => {
                const editButton = e.target.closest('.btn-edit-note');
                const deleteButton = e.target.closest('.btn-delete-note');

                if (editButton) {
                    const noteId = editButton.dataset.noteIdEdit; // ID is a string
                    const noteToEdit = notes.find(n => n.id === noteId);
                    if (noteToEdit) {
                        editingNote = { ...noteToEdit }; // Clone to avoid direct state mutation before save
                        isAddingNote = false; // Ensure add form is hidden
                        renderApp(); // Show edit form
                    }
                } else if (deleteButton) {
                    const noteId = deleteButton.dataset.noteIdDelete; // ID is a string
                    if (confirm('¿Estás seguro de que quieres eliminar esta nota?')) {
                        deleteNote(noteId); // This will call loadNotes() which calls renderApp()
                    }
                }
            });

            // Event delegation for dynamic content (accounts list)
            accountsList.addEventListener('click', (e) => {
                const editButton = e.target.closest('.btn-edit-account');
                const deleteButton = e.target.closest('.btn-delete-account');
                const addPaymentButton = e.target.closest('.btn-add-payment');
                const togglePaymentsButton = e.target.closest('.btn-toggle-payments');
                const deletePaymentButton = e.target.closest('.btn-delete-payment');

                if (editButton) {
                    const accountId = editButton.dataset.accountIdEdit; // ID is a string
                    const accountToEdit = accounts.find(a => a.id === accountId);
                    if (accountToEdit) {
                        editingAccount = { ...accountToEdit }; // Clone
                        isAddingAccount = false;
                        renderApp(); // Show edit form
                    }
                } else if (deleteButton) {
                    const accountId = deleteButton.dataset.accountIdDelete; // ID is a string
                    if (confirm('¿Estás seguro de que quieres eliminar esta cuenta y todos sus pagos?')) {
                        deleteAccount(accountId); // This will call loadAccounts() which calls renderApp()
                    }
                } else if (addPaymentButton) {
                    const accountId = addPaymentButton.dataset.accountIdAddpayment; // ID is a string
                    const amountInput = document.getElementById(`payment-amount-${accountId}`);
                    const descriptionInput = document.getElementById(`payment-description-${accountId}`);
                    if (amountInput && descriptionInput) {
                        const amount = amountInput.value;
                        const description = descriptionInput.value;
                        addPayment(accountId, amount, description); // This will call loadAccounts() which calls renderApp()
                        amountInput.value = ''; // Clear input
                        descriptionInput.value = ''; // Clear input
                    }
                } else if (togglePaymentsButton) {
                    const accountId = togglePaymentsButton.dataset.accountIdTogglepayments; // ID is a string
                    paymentHistoryVisibility[accountId] = !paymentHistoryVisibility[accountId];
                    renderApp(); // Re-render to show/hide payment history - This is a direct UI state change
                } else if (deletePaymentButton) {
                    const accountId = deletePaymentButton.dataset.accountIdDeletepayment; // ID is a string
                    const paymentId = deletePaymentButton.dataset.paymentId; // Payment ID is also a string
                     if (confirm('¿Estás seguro de que quieres eliminar este pago?')) {
                        deletePayment(accountId, paymentId); // This will call loadAccounts() which calls renderApp()
                    }
                }
            });
        }


        // Initial setup when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            setupEventListeners(); // Setup event listeners for static elements and delegation
            
            // Initial data load from Firestore
            // Show some loading indicator here if desired
            await loadNotes(); // This will call renderApp()
            await loadAccounts(); // This will also call renderApp(), effectively the last one dictates final render
            // If renderApp() is not called inside loadNotes/loadAccounts, call it here once.
            // Since they both call renderApp(), the UI will update after each load.
            // This is generally fine, but for a more controlled single initial render,
            // you might have loadNotes/loadAccounts only update their respective arrays
            // and then have a single renderApp() call here.
            // For now, the current approach (renderApp in each load function) is acceptable.
        });

    </script>
</body>
</html>
