<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bloc De Notas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <style>
        /* Custom styles if needed, e.g., for line-clamp */
        .line-clamp-3 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 3;
        }
        .line-clamp-2 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
        }
        .line-clamp-1 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 1;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-700 font-sans">
    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-3 w-full max-w-xs sm:max-w-sm">
        <!-- Toasts will be injected here -->
    </div>

    <div class="min-h-screen p-4 md:p-6 lg:p-8">
      <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 sm:p-8 mb-8">
          <h1 class="text-3xl sm:text-4xl font-bold text-blue-600 mb-1">Bloc De Notas</h1>
          <p class="text-gray-500 text-base sm:text-lg">Gestiona tus notas y cuentas de manera profesional</p>
        </div>

        <!-- Tabs -->
        <div class="flex space-x-2 mb-8">
          <button
            id="tab-notes"
            class="flex items-center px-4 py-2 rounded-md font-semibold text-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
          >
            <i data-lucide="file-text" class="w-5 h-5 mr-2"></i>
            Notas
          </button>
          <button
            id="tab-accounts"
            class="flex items-center px-4 py-2 rounded-md font-semibold text-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
          >
            <i data-lucide="calculator" class="w-5 h-5 mr-2"></i>
            Cuentas
          </button>
        </div>

        <!-- Content Area -->
        <div id="content-area">
            <!-- Notes Tab Content -->
            <div id="notes-section">
                <!-- Add Note Button -->
                <div class="mb-6">
                  <button
                    id="btn-add-note-form"
                    class="flex items-center px-5 py-2.5 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 hover:shadow-lg transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75"
                  >
                    <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                    Nueva Nota
                  </button>
                </div>

                <!-- Add/Edit Note Form Container -->
                <div id="note-form-container" class="hidden bg-white rounded-xl shadow-lg p-6 sm:p-8 mb-8">
                    <!-- Form will be injected here by JS -->
                </div>

                <!-- Notes List -->
                <div id="notes-list" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                  <!-- Notes will be injected here by JS -->
                </div>
            </div>

            <!-- Accounts Tab Content (Initially Hidden) -->
            <div id="accounts-section" class="hidden">
                <!-- Add Account Button -->
                <div class="mb-6">
                  <button
                    id="btn-add-account-form"
                    class="flex items-center px-5 py-2.5 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 hover:shadow-lg transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75"
                  >
                    <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                    Nueva Cuenta
                  </button>
                </div>

                <!-- Add/Edit Account Form Container -->
                <div id="account-form-container" class="hidden bg-white rounded-xl shadow-lg p-6 sm:p-8 mb-8">
                    <!-- Form will be injected here by JS -->
                </div>

                <!-- Accounts List -->
                <div id="accounts-list" class="space-y-6">
                  <!-- Accounts will be injected here by JS -->
                </div>
            </div>
        </div>
        
        <div id="empty-state" class="text-center py-12 hidden">
            <!-- Content injected by JS -->
        </div>

      </div>
    </div>
    
    <script>
        // State Variables
        let currentUserUID = null; // Added to store the current user's UID
        let activeTab = 'notes'; 
        let notes = [];
        let isAddingNote = false;
        let editingNote = null; 
        let newNote = { title: '', content: '', category: 'general' };
        const categories = ['general', 'trabajo', 'personal', 'importante', 'ideas'];

        let accounts = [];
        let isAddingAccount = false;
        let editingAccount = null; 
        let newAccount = { name: '', totalDebt: 0, totalPaid: 0, description: '', payments: [] };

        const tabNotes = document.getElementById('tab-notes');
        const tabAccounts = document.getElementById('tab-accounts');
        const notesSection = document.getElementById('notes-section');
        const accountsSection = document.getElementById('accounts-section');
        const btnAddNoteForm = document.getElementById('btn-add-note-form');
        const noteFormContainer = document.getElementById('note-form-container');
        const notesList = document.getElementById('notes-list');
        const btnAddAccountForm = document.getElementById('btn-add-account-form');
        const accountFormContainer = document.getElementById('account-form-container');
        const accountsList = document.getElementById('accounts-list');
        const emptyState = document.getElementById('empty-state');
        
        const firebaseConfig = {
            apiKey: "AIzaSyCQ-G2ozgY7TJ6VxLn69y6PzagcOn2Qb6U",
            authDomain: "regiform-lkct3.firebaseapp.com",
            projectId: "regiform-lkct3",
            storageBucket: "regiform-lkct3.firebasestorage.app",
            messagingSenderId: "1028711119142",
            appId: "1:1028711119142:web:cfc2e2a9996f58ed4469e7"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function renderLucideIcons() {
            lucide.createIcons();
        }

        function showToast(message, type = 'success', duration = 3500) {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;

            const toastId = 'toast-' + Date.now();
            const toast = document.createElement('div');
            toast.id = toastId;
            // Base classes for animation and positioning
            toast.className = `p-4 rounded-lg shadow-xl text-sm font-medium text-white transition-all duration-300 ease-in-out transform`;

            let bgColor = 'bg-blue-500'; // Default/info
            let icon = 'info';

            if (type === 'success') {
                bgColor = 'bg-green-500';
                icon = 'check-circle';
            } else if (type === 'error') {
                bgColor = 'bg-red-500';
                icon = 'x-circle';
            }
            toast.classList.add(bgColor);
            
            toast.innerHTML = `
                <div class="flex items-center">
                    <i data-lucide="${icon}" class="w-5 h-5 mr-3 flex-shrink-0"></i>
                    <span>${message}</span>
                </div>
            `;
            
            // Prepend so new toasts appear on top
            toastContainer.prepend(toast);
            renderLucideIcons(); 

            // Animate in (slide down and fade in)
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(-20px)';
            requestAnimationFrame(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateY(0)';
            });

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'scale(0.9)'; // Optional: shrink on exit
                toast.style.marginBottom = `-${toast.offsetHeight}px`; // Collapse space
                setTimeout(() => {
                    toast.remove();
                }, 300); 
            }, duration);
        }


        // Notes Functions
        async function addNote() {
            if (!newNote.title.trim() || !newNote.content.trim()) {
                showToast('El título y el contenido no pueden estar vacíos.', 'error');
                renderApp();
                return;
            }
            const noteToAdd = {
                ...newNote,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            try {
                await db.collection('notes').add(noteToAdd);
                showToast('Nota agregada exitosamente!');
                newNote = { title: '', content: '', category: 'general' };
                isAddingNote = false;
                await loadNotes(); 
            } catch (error) {
                console.error("Error adding note: ", error);
                showToast('Error al agregar nota.', 'error');
                renderApp(); 
            }
        }

        async function updateNote() {
            if (!editingNote || !editingNote.id || !editingNote.title.trim() || !editingNote.content.trim()) {
                showToast('Error: Datos de nota inválidos para actualizar.', 'error');
                renderApp();
                return;
            }
            const noteToUpdate = { 
                title: editingNote.title,
                content: editingNote.content,
                category: editingNote.category,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }; 
            try {
                await db.collection('notes').doc(editingNote.id).update(noteToUpdate);
                showToast('Nota actualizada!');
                editingNote = null;
                await loadNotes(); 
            } catch (error) {
                console.error("Error updating note: ", error);
                showToast('Error al actualizar nota.', 'error');
                renderApp(); 
            }
        }

        async function deleteNote(id) {
            if (!id) {
                showToast('Error: ID de nota inválido para eliminar.', 'error');
                return;
            }
            try {
                await db.collection('notes').doc(id).delete();
                showToast('Nota eliminada.');
                if (editingNote && editingNote.id === id) {
                    editingNote = null; 
                }
                await loadNotes(); 
            } catch (error) {
                console.error("Error deleting note: ", error);
                showToast('Error al eliminar nota.', 'error');
                renderApp(); 
            }
        }
        
        async function loadNotes() {
            if (activeTab === 'notes' && notesList) {
                 notesList.innerHTML = `<div class="col-span-full text-center p-6"><p class="text-gray-500 text-lg animate-pulse">Cargando notas...</p></div>`;
            }
            try {
                const snapshot = await db.collection('notes').orderBy('updatedAt', 'desc').get();
                notes = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return { 
                        id: doc.id, 
                        ...data,
                        createdAt: data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString() : 'N/A',
                        updatedAt: data.updatedAt?.toDate ? data.updatedAt.toDate().toLocaleString() : 'N/A',
                    };
                });
            } catch (error) {
                console.error("Error loading notes: ", error);
                showToast('Error al cargar notas.', 'error');
                notes = []; 
            }
            renderApp();
        }

        // Accounts Functions
        async function addAccount() {
            if (!newAccount.name.trim()) {
                 showToast('El nombre de la cuenta no puede estar vacío.', 'error');
                 renderApp();
                 return;
            }
            const accountToAdd = {
                name: newAccount.name,
                totalDebt: Number(newAccount.totalDebt) || 0,
                totalPaid: 0, // New accounts start with 0 paid
                description: newAccount.description || '',
                payments: [], 
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            try {
                await db.collection('accounts').add(accountToAdd);
                showToast('Cuenta agregada exitosamente!');
                newAccount = { name: '', totalDebt: 0, totalPaid: 0, description: '', payments: [] };
                isAddingAccount = false;
                await loadAccounts(); 
            } catch (error) {
                console.error("Error adding account: ", error);
                showToast('Error al agregar cuenta.', 'error');
                renderApp();
            }
        }

        async function updateAccount() {
            if (!editingAccount || !editingAccount.id || !editingAccount.name.trim()) {
                showToast('Error: Datos de cuenta inválidos para actualizar.', 'error');
                renderApp();
                return;
            }
            const accountToUpdate = {
                name: editingAccount.name,
                totalDebt: Number(editingAccount.totalDebt) || 0,
                description: editingAccount.description || '',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            try {
                await db.collection('accounts').doc(editingAccount.id).update(accountToUpdate);
                showToast('Cuenta actualizada!');
                editingAccount = null;
                await loadAccounts(); 
            } catch (error) {
                console.error("Error updating account: ", error);
                showToast('Error al actualizar cuenta.', 'error');
                renderApp();
            }
        }

        async function deleteAccount(id) {
            if (!id) {
                showToast('Error: ID de cuenta inválido para eliminar.', 'error');
                return;
            }
            try {
                await db.collection('accounts').doc(id).delete();
                showToast('Cuenta eliminada.');
                if (editingAccount && editingAccount.id === id) {
                    editingAccount = null;
                }
                await loadAccounts(); 
            } catch (error) {
                console.error("Error deleting account: ", error);
                showToast('Error al eliminar cuenta.', 'error');
                renderApp();
            }
        }

        async function addPayment(accountId, amountStr, description = '') {
            const amount = Number(amountStr);
            if (isNaN(amount) || amount <= 0) {
                showToast('El monto del pago debe ser un número positivo.', 'error');
                const amountInput = document.getElementById(`payment-amount-${accountId}`);
                if(amountInput) {
                    amountInput.focus();
                    amountInput.classList.add('border-red-500', 'ring-red-500');
                    setTimeout(() => amountInput.classList.remove('border-red-500', 'ring-red-500'), 2000);
                }
                return; // Don't renderApp here, let the focus and border be the feedback
            }
             if (!accountId) {
                showToast('Error: ID de cuenta inválido para agregar pago.', 'error');
                return;
            }

            const accountRef = db.collection('accounts').doc(accountId);
            try {
                await db.runTransaction(async (transaction) => {
                    const accountDoc = await transaction.get(accountRef);
                    if (!accountDoc.exists) {
                        throw "Account document does not exist!";
                    }
                    const accountData = accountDoc.data();
                    const newPayment = {
                        id: db.collection('tmp').doc().id,
                        amount: amount,
                        description: description || '',
                        date: firebase.firestore.Timestamp.now().toDate().toLocaleString()
                    };
                    const newPayments = [...(accountData.payments || []), newPayment];
                    const newTotalPaid = (accountData.totalPaid || 0) + amount;
                    transaction.update(accountRef, {
                        payments: newPayments,
                        totalPaid: newTotalPaid,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                showToast('Pago agregado!');
                await loadAccounts(); 
            } catch (error) {
                console.error("Error adding payment: ", error);
                showToast('Error al agregar pago.', 'error');
                renderApp(); // Re-render on error to ensure UI consistency if needed
            }
        }

        async function deletePayment(accountId, paymentId) {
            if (!accountId || !paymentId) {
                showToast('Error: IDs inválidos para eliminar pago.', 'error');
                return;
            }
            const accountRef = db.collection('accounts').doc(accountId);
            try {
                await db.runTransaction(async (transaction) => {
                    const accountDoc = await transaction.get(accountRef);
                    if (!accountDoc.exists) {
                        throw "Account document does not exist!";
                    }
                    const accountData = accountDoc.data();
                    const paymentToDelete = (accountData.payments || []).find(p => p.id === paymentId);
                    if (!paymentToDelete) {
                        console.warn("Payment not found for deletion:", paymentId);
                        showToast('Pago no encontrado para eliminar.', 'error');
                        return; 
                    }
                    const newPayments = (accountData.payments || []).filter(p => p.id !== paymentId);
                    let newTotalPaid = (accountData.totalPaid || 0) - paymentToDelete.amount;
                    newTotalPaid = newTotalPaid < 0 ? 0 : newTotalPaid;

                    transaction.update(accountRef, {
                        payments: newPayments,
                        totalPaid: newTotalPaid,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                showToast('Pago eliminado.');
                await loadAccounts(); 
            } catch (error) {
                console.error("Error deleting payment: ", error);
                showToast('Error al eliminar el pago.', 'error');
                renderApp();
            }
        }

        async function loadAccounts() {
            if (activeTab === 'accounts' && accountsList) {
                accountsList.innerHTML = `<div class="col-span-full text-center p-6"><p class="text-gray-500 text-lg animate-pulse">Cargando cuentas...</p></div>`;
            }
            try {
                const snapshot = await db.collection('accounts').orderBy('updatedAt', 'desc').get();
                accounts = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return { 
                        id: doc.id, 
                        ...data,
                        payments: data.payments || [],
                        createdAt: data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString() : 'N/A',
                        updatedAt: data.updatedAt?.toDate ? data.updatedAt.toDate().toLocaleString() : 'N/A',
                    };
                });
            } catch (error) {
                console.error("Error loading accounts: ", error);
                showToast('Error al cargar cuentas.', 'error');
                accounts = [];
            }
            renderApp();
        }

        // Helper Functions (getAccountStatus, getCategoryColor - already good)
        function getAccountStatus(account) {
            const remaining = (account.totalDebt || 0) - (account.totalPaid || 0);
            if (account.totalDebt > 0 && remaining <= 0) return 'paid';
            if ((account.totalPaid || 0) > 0 && (account.totalDebt || 0) > 0) return 'partial'; // Ensure there's debt for partial
            return 'pending';
        }

        function getCategoryColor(category) {
            const colors = {
                general: 'bg-gray-100 text-gray-800 border border-gray-300', 
                trabajo: 'bg-blue-100 text-blue-800 border border-blue-300',
                personal: 'bg-green-100 text-green-800 border border-green-300',
                importante: 'bg-red-100 text-red-800 border border-red-300', 
                ideas: 'bg-purple-100 text-purple-800 border border-purple-300'
            };
            return colors[category] || colors.general;
        }
        
        // --- Rendering Functions ---
        function renderApp() {
            renderTabs();
            renderNoteForm();
            renderNotes();
            renderAccountForm();
            renderAccounts();
            renderEmptyState(); // Must be after notes/accounts render to check lengths
            renderLucideIcons(); 
        }
        
        function renderTabs() {
            const activeClasses = ['bg-blue-600', 'text-white', 'shadow-md'];
            const inactiveClasses = ['bg-white', 'text-gray-700', 'hover:bg-gray-100', 'hover:text-blue-600'];

            if (activeTab === 'notes') {
                tabNotes.classList.add(...activeClasses);
                tabNotes.classList.remove(...inactiveClasses);
                tabAccounts.classList.add(...inactiveClasses);
                tabAccounts.classList.remove(...activeClasses);
                notesSection.classList.remove('hidden');
                accountsSection.classList.add('hidden');
            } else { 
                tabAccounts.classList.add(...activeClasses);
                tabAccounts.classList.remove(...inactiveClasses);
                tabNotes.classList.add(...inactiveClasses);
                tabNotes.classList.remove(...activeClasses);
                accountsSection.classList.remove('hidden');
                notesSection.classList.add('hidden');
            }
        }

        function renderNoteForm() {
            if (isAddingNote || editingNote) {
                noteFormContainer.classList.remove('hidden');
                const currentData = editingNote || newNote;
                const isEditMode = !!editingNote;
                noteFormContainer.innerHTML = `
                    <h3 class="text-xl font-semibold mb-6 text-gray-800">${isEditMode ? 'Editar Nota' : 'Nueva Nota'}</h3>
                    <div class="space-y-5">
                        <div>
                            <label for="note-title-input" class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                            <input type="text" id="note-title-input" placeholder="Título de la nota" value="${currentData.title}" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow"/>
                        </div>
                        <div>
                            <label for="note-category-select" class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                            <select id="note-category-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow">
                                ${categories.map(cat => `<option value="${cat}" ${currentData.category === cat ? 'selected' : ''}>${cat.charAt(0).toUpperCase() + cat.slice(1)}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label for="note-content-input" class="block text-sm font-medium text-gray-700 mb-1">Contenido</label>
                            <textarea id="note-content-input" placeholder="Contenido de la nota" rows="6" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow">${currentData.content}</textarea>
                        </div>
                        <div class="flex space-x-3 pt-3">
                            <button id="btn-save-note" class="flex items-center justify-center px-5 py-2.5 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 hover:shadow-lg transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75"><i data-lucide="save" class="w-4 h-4 mr-2"></i>Guardar</button>
                            <button id="btn-cancel-note" class="flex items-center justify-center px-5 py-2.5 bg-gray-500 text-white rounded-lg shadow-md hover:bg-gray-600 hover:shadow-lg transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50"><i data-lucide="x" class="w-4 h-4 mr-2"></i>Cancelar</button>
                        </div>
                    </div>`;
                document.getElementById('note-title-input').addEventListener('input', (e) => { if (isEditMode) editingNote.title = e.target.value; else newNote.title = e.target.value; });
                document.getElementById('note-category-select').addEventListener('change', (e) => { if (isEditMode) editingNote.category = e.target.value; else newNote.category = e.target.value; });
                document.getElementById('note-content-input').addEventListener('input', (e) => { if (isEditMode) editingNote.content = e.target.value; else newNote.content = e.target.value; });
                document.getElementById('btn-save-note').addEventListener('click', () => { if (isEditMode) updateNote(); else addNote(); });
                document.getElementById('btn-cancel-note').addEventListener('click', () => { isAddingNote = false; editingNote = null; renderApp(); });
            } else {
                noteFormContainer.classList.add('hidden');
                noteFormContainer.innerHTML = '';
            }
        }

        function renderNotes() {
            if (!notesList) return; // Guard clause
            notesList.innerHTML = ''; 
            if (notes.length === 0 && activeTab === 'notes' && !isAddingNote && !editingNote) {
                // Empty state will be handled by renderEmptyState
            } else if (activeTab === 'notes') { // Only render if notes tab is active
                notes.forEach(note => {
                    const noteEl = document.createElement('div');
                    noteEl.className = 'bg-white rounded-xl shadow-lg p-5 transform hover:shadow-xl hover:-translate-y-1 transition-all duration-200 ease-in-out flex flex-col justify-between';
                    noteEl.innerHTML = `
                        <div>
                            <div class="flex justify-between items-start mb-2.5">
                                <h3 class="font-semibold text-lg text-gray-800 line-clamp-2">${note.title}</h3>
                                <div class="flex space-x-1 flex-shrink-0">
                                    <button data-note-id-edit="${note.id}" class="btn-edit-note p-1.5 text-gray-500 hover:text-blue-600 rounded-md hover:bg-blue-50 transition-colors"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                    <button data-note-id-delete="${note.id}" class="btn-delete-note p-1.5 text-gray-500 hover:text-red-600 rounded-md hover:bg-red-50 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                            <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold mb-3 ${getCategoryColor(note.category)}">${note.category.charAt(0).toUpperCase() + note.category.slice(1)}</span>
                            <p class="text-gray-600 text-sm mb-4 line-clamp-3">${note.content}</p>
                        </div>
                        <div class="text-xs text-gray-400 border-t border-gray-200 pt-2.5 mt-auto">
                            <p>Creado: ${note.createdAt}</p>
                            ${note.updatedAt !== note.createdAt ? `<p>Actualizado: ${note.updatedAt}</p>` : ''}
                        </div>`;
                    notesList.appendChild(noteEl);
                });
            }
        }

        function renderAccountForm() {
            if (isAddingAccount || editingAccount) {
                accountFormContainer.classList.remove('hidden');
                const currentData = editingAccount || newAccount;
                const isEditMode = !!editingAccount;
                accountFormContainer.innerHTML = `
                    <h3 class="text-xl font-semibold mb-6 text-gray-800">${isEditMode ? 'Editar Cuenta' : 'Nueva Cuenta'}</h3>
                    <div class="space-y-5">
                        <div>
                            <label for="account-name-input" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la cuenta</label>
                            <input type="text" id="account-name-input" placeholder="Ej: Tarjeta de Crédito Banco X" value="${currentData.name}" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow"/>
                        </div>
                        <div>
                            <label for="account-totaldebt-input" class="block text-sm font-medium text-gray-700 mb-1">Total a deber ($)</label>
                            <input type="number" step="0.01" id="account-totaldebt-input" placeholder="0.00" value="${currentData.totalDebt}" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow"/>
                        </div>
                        <div>
                            <label for="account-description-input" class="block text-sm font-medium text-gray-700 mb-1">Descripción (opcional)</label>
                            <textarea id="account-description-input" placeholder="Ej: Compras varias del mes de Mayo" rows="3" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow">${currentData.description}</textarea>
                        </div>
                        <div class="flex space-x-3 pt-3">
                            <button id="btn-save-account" class="flex items-center justify-center px-5 py-2.5 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 hover:shadow-lg transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75"><i data-lucide="save" class="w-4 h-4 mr-2"></i>Guardar</button>
                            <button id="btn-cancel-account" class="flex items-center justify-center px-5 py-2.5 bg-gray-500 text-white rounded-lg shadow-md hover:bg-gray-600 hover:shadow-lg transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50"><i data-lucide="x" class="w-4 h-4 mr-2"></i>Cancelar</button>
                        </div>
                    </div>`;
                document.getElementById('account-name-input').addEventListener('input', (e) => { if (isEditMode) editingAccount.name = e.target.value; else newAccount.name = e.target.value; });
                document.getElementById('account-totaldebt-input').addEventListener('input', (e) => { const value = Number(e.target.value); if (isEditMode) editingAccount.totalDebt = value; else newAccount.totalDebt = value; });
                document.getElementById('account-description-input').addEventListener('input', (e) => { if (isEditMode) editingAccount.description = e.target.value; else newAccount.description = e.target.value; });
                document.getElementById('btn-save-account').addEventListener('click', () => { if (isEditMode) updateAccount(); else addAccount(); });
                document.getElementById('btn-cancel-account').addEventListener('click', () => { isAddingAccount = false; editingAccount = null; renderApp(); });
            } else {
                accountFormContainer.classList.add('hidden');
                accountFormContainer.innerHTML = '';
            }
        }
        
        function renderAccounts() {
            if (!accountsList) return; // Guard clause
            accountsList.innerHTML = ''; 
            if (accounts.length === 0 && activeTab === 'accounts' && !isAddingAccount && !editingAccount) {
                // Empty state will be handled by renderEmptyState
            } else if (activeTab === 'accounts') { // Only render if accounts tab is active
                accounts.forEach(account => {
                    const accountCard = renderAccountCard(account);
                    accountsList.appendChild(accountCard);
                });
            }
        }

        let paymentHistoryVisibility = {}; 
        function renderAccountCard(account) {
            const cardEl = document.createElement('div');
            const status = getAccountStatus(account);
            const remaining = (account.totalDebt || 0) - (account.totalPaid || 0);
            const baseColor = status === 'paid' ? 'green' : status === 'partial' ? 'yellow' : 'red';

            cardEl.className = `bg-white rounded-xl shadow-lg border-l-4 border-${baseColor}-500 overflow-hidden transition-all duration-200 hover:shadow-xl`;
            cardEl.innerHTML = `
                <div class="p-5">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 line-clamp-1">${account.name}</h3>
                            <span class="inline-block px-3 py-0.5 rounded-full text-xs font-semibold bg-${baseColor}-100 text-${baseColor}-700 border border-${baseColor}-300">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                        </div>
                        <div class="flex space-x-1 flex-shrink-0">
                            <button data-account-id-edit="${account.id}" class="btn-edit-account p-1.5 text-gray-500 hover:text-blue-600 rounded-md hover:bg-blue-50 transition-colors"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                            <button data-account-id-delete="${account.id}" class="btn-delete-account p-1.5 text-gray-500 hover:text-red-600 rounded-md hover:bg-red-50 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    ${account.description ? `<p class="text-gray-600 text-sm mb-4 line-clamp-2">${account.description}</p>` : ''}
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-x-4 gap-y-3 mb-5">
                        <div><p class="text-xs text-gray-500 uppercase tracking-wider">Total Deuda</p><p class="text-lg font-semibold text-gray-800">$${(account.totalDebt || 0).toFixed(2)}</p></div>
                        <div><p class="text-xs text-gray-500 uppercase tracking-wider">Total Pagado</p><p class="text-lg font-semibold text-blue-600">$${(account.totalPaid || 0).toFixed(2)}</p></div>
                        <div><p class="text-xs text-gray-500 uppercase tracking-wider">Restante</p><p class="text-lg font-semibold text-${baseColor}-600">$${Math.max(0, remaining).toFixed(2)}</p></div>
                        <div><p class="text-xs text-gray-500 uppercase tracking-wider">Progreso</p><p class="text-lg font-semibold text-purple-600">${(account.totalDebt || 0) > 0 ? (((account.totalPaid || 0) / (account.totalDebt || 0)) * 100).toFixed(0) : ((account.totalPaid || 0) > 0 ? 100 : 0)}%</p></div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6"><div class="h-2.5 rounded-full transition-all duration-500 ease-out bg-${baseColor}-500" style="width: ${(account.totalDebt || 0) > 0 ? Math.min(((account.totalPaid || 0) / (account.totalDebt || 0)) * 100, 100) : ((account.totalPaid || 0) > 0 ? 100 : 0)}%"></div></div>
                    <div class="border-t border-gray-200 pt-4">
                        <h4 class="text-sm font-semibold text-gray-700 mb-2">Registrar Nuevo Pago</h4>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mb-4">
                            <input type="number" step="0.01" placeholder="Monto" id="payment-amount-${account.id}" class="flex-grow p-2.5 border border-gray-300 rounded-md shadow-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-shadow"/>
                            <input type="text" placeholder="Descripción (opcional)" id="payment-description-${account.id}" class="flex-grow p-2.5 border border-gray-300 rounded-md shadow-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-shadow"/>
                            <button data-account-id-addpayment="${account.id}" class="btn-add-payment flex items-center justify-center px-4 py-2.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"><i data-lucide="dollar-sign" class="w-4 h-4 mr-2"></i>Pagar</button>
                        </div>
                        <button data-account-id-togglepayments="${account.id}" class="btn-toggle-payments text-sm font-medium text-blue-600 hover:text-blue-700 hover:underline flex items-center py-1"><i data-lucide="${paymentHistoryVisibility[account.id] ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4 mr-1.5"></i>${paymentHistoryVisibility[account.id] ? 'Ocultar' : 'Ver'} Historial de Pagos (${(account.payments || []).length})</button>
                        <div id="payments-history-${account.id}" class="mt-2.5 space-y-2 ${paymentHistoryVisibility[account.id] ? '' : 'hidden'}">
                            ${(account.payments && account.payments.length > 0) ? account.payments.slice().reverse().map(payment => `<div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-200 shadow-sm"><div><p class="font-medium text-gray-800">$${payment.amount.toFixed(2)}</p>${payment.description ? `<p class="text-sm text-gray-600">${payment.description}</p>` : ''}<p class="text-xs text-gray-500">${payment.date}</p></div><button data-account-id-deletepayment="${account.id}" data-payment-id="${payment.id}" class="btn-delete-payment p-1.5 text-red-500 hover:text-red-700 rounded-md hover:bg-red-50 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`).join('') : '<p class="text-sm text-gray-500 py-2 italic">No hay pagos registrados.</p>'}
                        </div>
                    </div>
                </div>`;
            return cardEl;
        }

        function renderEmptyState() {
            const shouldShowEmptyState = (activeTab === 'notes' && notes.length === 0 && !isAddingNote && !editingNote) ||
                                       (activeTab === 'accounts' && accounts.length === 0 && !isAddingAccount && !editingAccount);
            if (shouldShowEmptyState) {
                emptyState.classList.remove('hidden');
                let iconHtml = '';
                let typeText = activeTab === 'notes' ? 'notas' : 'cuentas';
                iconHtml = `<i data-lucide="${activeTab === 'notes' ? 'file-text' : 'credit-card'}" class="w-16 h-16 text-gray-400 mb-4"></i>`;
                emptyState.innerHTML = `<div class="flex flex-col items-center justify-center p-10 bg-white rounded-xl shadow-lg">${iconHtml}<p class="text-gray-600 text-xl font-semibold mb-1">No hay ${typeText} aún.</p><p class="text-gray-500 text-sm">¡Crea la primera para empezar!</p></div>`;
                if(iconHtml) renderLucideIcons();
            } else {
                emptyState.classList.add('hidden');
            }
        }

        function setupEventListeners() {
            tabNotes.addEventListener('click', () => { activeTab = 'notes'; isAddingNote = false; editingNote = null; isAddingAccount = false; editingAccount = null; renderApp(); });
            tabAccounts.addEventListener('click', () => { activeTab = 'accounts'; isAddingAccount = false; editingAccount = null; isAddingNote = false; editingNote = null; renderApp(); });
            btnAddNoteForm.addEventListener('click', () => { isAddingNote = true; editingNote = null; newNote = { title: '', content: '', category: 'general' }; renderApp(); noteFormContainer.scrollIntoView({ behavior: 'smooth', block: 'center' }); setTimeout(() => document.getElementById('note-title-input')?.focus(), 150); });
            btnAddAccountForm.addEventListener('click', () => { isAddingAccount = true; editingAccount = null; newAccount = { name: '', totalDebt: 0, totalPaid: 0, description: '', payments: [] }; renderApp(); accountFormContainer.scrollIntoView({ behavior: 'smooth', block: 'center' }); setTimeout(() => document.getElementById('account-name-input')?.focus(), 150); });
            notesList.addEventListener('click', (e) => {
                const editButton = e.target.closest('.btn-edit-note');
                const deleteButton = e.target.closest('.btn-delete-note');
                if (editButton) { const noteId = editButton.dataset.noteIdEdit; const noteToEdit = notes.find(n => n.id === noteId); if (noteToEdit) { editingNote = { ...noteToEdit }; isAddingNote = false; renderApp(); noteFormContainer.scrollIntoView({ behavior: 'smooth', block: 'center' }); setTimeout(() => document.getElementById('note-title-input')?.focus(), 150); } }
                else if (deleteButton) { const noteId = deleteButton.dataset.noteIdDelete; if (confirm('¿Estás seguro de que quieres eliminar esta nota?')) { deleteNote(noteId); } }
            });
            accountsList.addEventListener('click', (e) => {
                const editButton = e.target.closest('.btn-edit-account');
                const deleteButton = e.target.closest('.btn-delete-account');
                const addPaymentButton = e.target.closest('.btn-add-payment');
                const togglePaymentsButton = e.target.closest('.btn-toggle-payments');
                const deletePaymentButton = e.target.closest('.btn-delete-payment');
                if (editButton) { const accountId = editButton.dataset.accountIdEdit; const accountToEdit = accounts.find(a => a.id === accountId); if (accountToEdit) { editingAccount = { ...accountToEdit }; isAddingAccount = false; renderApp(); accountFormContainer.scrollIntoView({ behavior: 'smooth', block: 'center' }); setTimeout(() => document.getElementById('account-name-input')?.focus(), 150); } }
                else if (deleteButton) { const accountId = deleteButton.dataset.accountIdDelete; if (confirm('¿Estás seguro de que quieres eliminar esta cuenta y todos sus pagos?')) { deleteAccount(accountId); } }
                else if (addPaymentButton) { const accountId = addPaymentButton.dataset.accountIdAddpayment; const amountInput = document.getElementById(`payment-amount-${accountId}`); const descriptionInput = document.getElementById(`payment-description-${accountId}`); if (amountInput && descriptionInput && amountInput.value) { addPayment(accountId, amountInput.value, descriptionInput.value); amountInput.value = ''; descriptionInput.value = ''; } else if (amountInput && !amountInput.value) { amountInput.focus(); amountInput.classList.add('border-red-500', 'ring-red-500'); setTimeout(() => amountInput.classList.remove('border-red-500', 'ring-red-500'), 2000); } }
                else if (togglePaymentsButton) { const accountId = togglePaymentsButton.dataset.accountIdTogglepayments; paymentHistoryVisibility[accountId] = !paymentHistoryVisibility[accountId]; renderApp(); }
                else if (deletePaymentButton) { const accountId = deletePaymentButton.dataset.accountIdDeletepayment; const paymentId = deletePaymentButton.dataset.paymentId; if (confirm('¿Estás seguro de que quieres eliminar este pago?')) { deletePayment(accountId, paymentId); } }
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            setupEventListeners(); 
            renderTabs(); // Initial tab styling
            // Initial data load will show loading messages due to changes in loadNotes/loadAccounts
            await Promise.all([loadNotes(), loadAccounts()]);
            // renderApp() is called within loadNotes and loadAccounts, so UI will be up to date.
        });
    </script>
</body>
</html>

     
