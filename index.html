<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotasPay</title>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        /* Global Styles & Variables */
        :root {
            --font-family-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            
            /* Light Theme (Default) */
            --bg-gradient-start: #EFF6FF; /* blue-50 */
            --bg-gradient-mid: #FFFFFF;   /* white */
            --bg-gradient-end: #F3E8FF;   /* purple-50 */
            --text-primary: #1F2937;     /* gray-900 */
            --text-secondary: #4B5563;   /* gray-600 */
            --text-muted: #6B7280;       /* gray-500 */
            --border-color: #E5E7EB;     /* gray-200 */
            --bg-card: #FFFFFF;
            --bg-input: #F9FAFB;         /* gray-50 */
            --bg-input-focus-ring: #60A5FA; /* blue-500 */
            --header-bg: rgba(255, 255, 255, 0.8);
            --header-border: #E5E7EB;    /* gray-200 */
            --button-secondary-bg: #F3F4F6; /* gray-100 */
            --button-secondary-hover-bg: #E5E7EB; /* gray-200 */
            --button-secondary-text: #4B5563; /* gray-600 */
            --icon-secondary-color: #4B5563; /* gray-600 */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

            --blue-500: #3B82F6;
            --purple-500: #8B5CF6;
            --pink-500: #EC4899;
            --green-500: #22C55E;
            --orange-500: #F97316;
            --red-500: #EF4444;
            --yellow-400: #FACC15;
        }

        html[data-theme="dark"] {
            --bg-gradient-start: #1F2937; /* gray-900 */
            --bg-gradient-mid: #111827;   /* gray-800 */
            --bg-gradient-end: #000000;   /* black */
            --text-primary: #F9FAFB;     /* white */
            --text-secondary: #D1D5DB;   /* gray-300 */
            --text-muted: #9CA3AF;       /* gray-400 */
            --border-color: #4B5563;     /* gray-600 */
            --bg-card: #1F2937;         /* gray-800 */
            --bg-input: #374151;         /* gray-700 */
            --header-bg: rgba(31, 41, 55, 0.8); /* gray-900/80 */
            --header-border: #374151;    /* gray-700 */
            --button-secondary-bg: #374151; /* gray-700 */
            --button-secondary-hover-bg: #4B5563; /* gray-600 */
            --button-secondary-text: #D1D5DB; /* gray-300 */
            --icon-secondary-color: #9CA3AF; /* gray-400 */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.25), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
            --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.3), 0 10px 10px -5px rgba(0,0,0,0.2);
        }

        body {
            font-family: var(--font-family-sans);
            margin: 0;
            background-image: linear-gradient(to bottom right, var(--bg-gradient-start), var(--bg-gradient-mid), var(--bg-gradient-end));
            color: var(--text-primary);
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
            font-size: 16px; /* Base font size */
        }

        * {
            box-sizing: border-box;
        }

        .container {
            max-width: 64rem; /* 1024px, max-w-6xl */
            margin-left: auto;
            margin-right: auto;
            padding-left: 1rem; /* px-4 */
            padding-right: 1rem; /* px-4 */
        }

        /* Header */
        #app-header {
            position: sticky;
            top: 0;
            z-index: 50;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--header-border);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 1rem; 
            padding-bottom: 1rem; 
        }

        .app-title {
            font-size: 1.5rem; /* text-2xl */
            font-weight: bold;
            background-image: linear-gradient(to right, #60A5FA, #A78BFA); /* from-blue-400 to-purple-400 */
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem; /* gap-3 */
        }

        .header-actions button {
            padding: 0.5rem; /* p-2 */
            border-radius: 0.5rem; /* rounded-lg */
            background-color: var(--button-secondary-bg);
            color: var(--button-secondary-text);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex; /* For icon alignment */
            align-items: center;
            justify-content: center;
        }
        .header-actions button:hover {
            transform: scale(1.05);
            background-color: var(--button-secondary-hover-bg);
        }
        
        html[data-theme="dark"] #theme-toggle-btn {
            color: var(--yellow-400);
        }
        html:not([data-theme="dark"]) #theme-toggle-btn {
            color: var(--icon-secondary-color);
        }


        /* Tabs */
        .tabs {
            display: flex;
            margin-top: 1rem; /* mt-4 */
            gap: 0.25rem; /* gap-1 */
        }

        .tab-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem; /* gap-2 */
            padding: 0.5rem 1rem; /* px-4 py-2 */
            border-radius: 0.5rem; /* rounded-lg */
            border: none;
            background-color: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-weight: 500; /* medium */
        }
        
        html[data-theme="dark"] .tab-btn:not(.active):hover {
            color: var(--text-primary);
            background-color: var(--button-secondary-hover-bg);
        }
        html:not([data-theme="dark"]) .tab-btn:not(.active):hover {
            color: var(--text-primary); /* gray-900 */
            background-color: var(--button-secondary-hover-bg); /* gray-100 */
        }
        
        .tab-btn.active {
            color: white;
            box-shadow: var(--shadow-lg);
        }

        #notes-tab-btn.active {
            background-color: var(--blue-500);
        }
        #payments-tab-btn.active {
            background-color: var(--purple-500);
        }
        
        .tab-btn svg, .header-actions button svg {
            width: 20px; /* size-20 from react, 1.25rem */
            height: 20px;
        }
        .tab-btn svg {
             width: 18px; /* size-18 from react */
             height: 18px;
        }


        /* Main Content */
        #app-content {
            padding-top: 1.5rem; /* py-6 */
            padding-bottom: 1.5rem; /* py-6 */
        }

        .tab-content {
            display: none; 
        }
        .tab-content.active {
            display: block;
        }
        
        .space-y-6 > *:not(:last-child) {
            margin-bottom: 1.5rem; 
        }
        .space-y-4 > *:not(:last-child) {
            margin-bottom: 1rem;
        }
        .space-y-3 > *:not(:last-child) {
            margin-bottom: 0.75rem;
        }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }


        /* General Form elements & Cards */
        .card {
            padding: 1.5rem; /* p-6 */
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px solid var(--border-color);
            background-color: var(--bg-card);
            transition: all 0.3s ease;
        }
        html:not([data-theme="dark"]) .card {
            box-shadow: var(--shadow-sm);
        }


        input[type="text"],
        input[type="number"],
        input[type="date"],
        textarea {
            width: 100%;
            padding: 0.75rem 1rem; 
            border-radius: 0.5rem; /* rounded-lg */
            border: 1px solid var(--border-color);
            background-color: var(--bg-input);
            color: var(--text-primary);
            transition: all 0.2s ease-in-out;
            font-size: 1rem;
        }
        /* Specific padding for search bar */
        #notes-search-input {
             padding-left: 2.5rem; /* pl-10 */
             padding-top: 0.75rem; /* py-3 */
             padding-bottom: 0.75rem; /* py-3 */
             border-radius: 0.75rem; /* rounded-xl */
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--bg-input-focus-ring);
            box-shadow: 0 0 0 2px var(--bg-input-focus-ring); /* focus:ring-2 */
        }
        textarea {
            resize: none; 
        }
        
        .form-field-title {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            margin-bottom: 1rem; /* mb-4 */
        }

        button.action-btn {
            /* width: 100%; */ /* Removed to allow natural width for some buttons */
            color: white;
            padding-top: 0.75rem; 
            padding-bottom: 0.75rem;
            padding-left: 1rem;
            padding-right: 1rem;
            border-radius: 0.5rem; /* rounded-lg */
            border: none;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* gap-2 */
            font-weight: 500; /* font-medium */
        }
        button.action-btn.full-width { /* Add this class if 100% width is needed */
             width: 100%;
        }

        button.action-btn svg {
            width: 20px;
            height: 20px;
        }
        
        .notes-add-btn {
            background-image: linear-gradient(to right, var(--blue-500), var(--purple-500));
        }
        .notes-add-btn:hover {
            background-image: linear-gradient(to right, #2563EB, #7C3AED); /* hover:from-blue-600 hover:to-purple-600 */
        }

        .payments-add-btn { /* For the main "Add Payment" in the form */
             background-image: linear-gradient(to right, var(--purple-500), var(--pink-500));
        }
        .payments-add-btn:hover {
            background-image: linear-gradient(to right, #7C3AED, #DB2777); /* hover:from-purple-600 hover:to-pink-600 */
        }
        /* Specific button for "Abonar" */
        .payment-abono-btn {
            background-color: var(--blue-500);
            padding-left: 1rem; padding-right: 1rem; /* px-4 */
            padding-top: 0.5rem; padding-bottom: 0.5rem; /* py-2 */
            font-size: 0.875rem; /* text-sm */
        }
        .payment-abono-btn:hover {
            background-color: #2563EB; /* blue-600 */
        }


        /* Grid */
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }

        @media (min-width: 768px) { /* md: */
            .md-grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .md-grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        }
        @media (min-width: 1024px) { /* lg: */
            .lg-grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .lg-grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); } /* For new payment form */
        }
        
        /* Utility classes */
        .hidden { display: none !important; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .left-3 { left: 0.75rem; }
        .top-1\/2 { top: 50%; }
        .transform { transform: translate(var(--tw-translate-x,0), var(--tw-translate-y,0)) rotate(var(--tw-rotate,0)) skewX(var(--tw-skew-x,0)) skewY(var(--tw-skew-y,0)) scaleX(var(--tw-scale-x,1)) scaleY(var(--tw-scale-y,1)); } /* basic transform */
        .-translate-y-1\/2 { --tw-translate-y: -50%; transform: translate(var(--tw-translate-x,0), var(--tw-translate-y,0)) rotate(var(--tw-rotate,0)) skewX(var(--tw-skew-x,0)) skewY(var(--tw-skew-y,0)) scaleX(var(--tw-scale-x,1)) scaleY(var(--tw-scale-y,1));}
        .text-gray-400 { color: var(--text-muted); } 
        .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .leading-relaxed { line-height: 1.625; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .text-lg { font-size: 1.125rem; }
        .text-2xl { font-size: 1.5rem; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .text-center { text-align: center; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-auto { margin-top: auto; }
        .pt-2 { padding-top: 0.5rem; }
        .py-12 { padding-top: 3rem; padding-bottom: 3rem; }
        .opacity-0 { opacity: 0; }
        .group:hover .group-hover-opacity-100 { opacity: 1; }
        .transition-opacity { transition-property: opacity; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .items-start { align-items: flex-start; }
        .items-end { align-items: flex-end; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .flex-1 { flex: 1 1 0%; }
        .w-full { width: 100%; }
        .border-t { border-top-width: 1px; }


        /* Note card styling */
        .note-card {
            padding: 1.25rem; /* p-5 */
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px solid var(--border-color);
            background-color: var(--bg-card);
            transition: all 0.3s ease;
            display: flex; 
            flex-direction: column; 
        }
        .note-card-content-wrapper { 
            flex-grow: 1;
        }

        html:not([data-theme="dark"]) .note-card {
             box-shadow: var(--shadow-sm);
        }
        html:not([data-theme="dark"]) .note-card:hover {
            box-shadow: var(--shadow-xl);
        }
        html[data-theme="dark"] .note-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2), 0 4px 6px -2px rgba(0,0,0,0.1);
        }

        .note-card-actions button {
            padding: 0.375rem; /* p-1.5 */
            border-radius: 0.5rem; /* rounded-lg */
            transition: all 0.2s ease;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
        }
        html[data-theme="dark"] .note-card-actions button:hover:not(.delete-action) {
            background-color: var(--button-secondary-hover-bg); 
            color: var(--text-primary); 
        }
        html:not([data-theme="dark"]) .note-card-actions button:hover:not(.delete-action) {
            background-color: var(--button-secondary-hover-bg); 
            color: var(--text-secondary); 
        }
        .note-card-actions button.delete-action:hover,
        .payment-card-delete-btn:hover { /* Added general class for payment delete */
            background-color: var(--red-500);
            color: white;
        }
        .note-card-actions button svg, .payment-card-delete-btn svg {
            width: 16px; height: 16px;
        }
        .note-card .editing-note-title-input, .note-card .editing-note-content-input {
            background-color: var(--bg-input); 
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }


        /* Payment card specific styles */
        .payment-card {
            padding: 1.25rem; /* p-5 */
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px solid var(--border-color);
            background-color: var(--bg-card);
            transition: all 0.3s ease;
        }
        html:not([data-theme="dark"]) .payment-card {
             box-shadow: var(--shadow-sm);
        }
        .payment-card.overdue-border { /* Updated class name for clarity */
            border-left: 4px solid var(--red-500); 
        }
         html[data-theme="dark"] .payment-card.overdue-border {
            border-left-color: var(--red-500);
        }
        .payment-card-delete-btn { /* Style for delete button on payment card */
            padding: 0.5rem; /* p-2 */
            border-radius: 0.5rem; /* rounded-lg */
            transition: all 0.2s ease;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
        }


        .status-badge {
            padding: 0.25rem 0.5rem; /* px-2 py-1 */
            border-radius: 9999px; /* rounded-full */
            font-size: 0.75rem; /* text-xs */
            font-weight: 500; /* font-medium */
            display: inline-flex;
            align-items: center;
            gap: 0.25rem; /* gap-1 */
        }
        .status-badge.completed {
            background-color: var(--green-500);
            color: white;
        }
        .status-badge.overdue {
            background-color: var(--red-500);
            color: white;
        }
        .status-badge svg { width: 12px; height: 12px; }

        .progress-bar-bg {
            width: 100%;
            background-color: #E5E7EB; 
            border-radius: 9999px; 
            height: 0.75rem; 
            overflow: hidden;
        }
        html[data-theme="dark"] .progress-bar-bg {
            background-color: #374151; 
        }
        .progress-bar-fill {
            height: 100%;
            transition: width 0.5s ease-in-out; /* Smoother transition */
            background-image: linear-gradient(to right, var(--blue-500), var(--purple-500));
        }
        .progress-bar-fill.completed {
            background-image: none;
            background-color: var(--green-500);
        }
        .progress-bar-fill.overdue {
            background-image: none;
            background-color: var(--red-500);
        }

        /* Payment summary cards */
        .summary-card {
            padding: 1rem; /* p-4 */
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px solid var(--border-color);
            background-color: var(--bg-card);
        }
         html:not([data-theme="dark"]) .summary-card {
            box-shadow: var(--shadow-sm);
        }
        .summary-card .label {
            font-size: 0.875rem; /* text-sm */
            color: var(--text-secondary);
        }
        .summary-card .value {
            font-size: 1.5rem; /* text-2xl */
            font-weight: bold;
        }
        .summary-card .value.total { color: var(--blue-500); }
        .summary-card .value.paid { color: var(--green-500); }
        .summary-card .value.remaining { color: var(--orange-500); }
        .summary-card .value.completed { color: var(--purple-500); }

        /* Input for abono, specifically */
        .payment-abono-input {
            font-size: 0.875rem; /* text-sm */
            padding: 0.5rem 0.75rem; /* px-3 py-2 */
        }


    </style>
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header id="app-header">
            <div class="container">
                <div class="header-content">
                    <h1 class="app-title">NotasPay</h1>
                    <div class="header-actions">
                        <button id="export-data-btn" title="Exportar datos">
                            <i data-lucide="download"></i>
                        </button>
                        <button id="theme-toggle-btn" title="Cambiar tema">
                            <i data-lucide="sun" id="sun-icon"></i>
                            <i data-lucide="moon" id="moon-icon" class="hidden"></i>
                        </button>
                    </div>
                </div>
                <nav class="tabs">
                    <button id="notes-tab-btn" data-tab="notes" class="tab-btn active">
                        <i data-lucide="file-text"></i>
                        <span>Notas</span>
                    </button>
                    <button id="payments-tab-btn" data-tab="payments" class="tab-btn">
                        <i data-lucide="credit-card"></i>
                        <span>Pagos</span>
                    </button>
                </nav>
            </div>
        </header>

        <!-- Main Content -->
        <main id="app-content" class="container">
            <section id="notes-section" class="tab-content active">
                <!-- Content rendered by renderNotesSection -->
            </section>
            <section id="payments-section" class="tab-content" style="display: none;">
                <!-- Content rendered by renderPaymentsSection -->
            </section>
        </main>
    </div>

    <script>
        // APP STATE
        let state = {
            darkMode: true,
            activeTab: 'notes',
            notes: [],
            payments: [],
            searchTerm: '',
            editingNoteId: null,
            tempEditingNote: null, 
            newNote: { title: '', content: '' },
            newPayment: { description: '', totalAmount: '', dueDate: ''} 
        };

        // DOM Elements
        const appElement = document.documentElement;
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        const notesTabBtn = document.getElementById('notes-tab-btn');
        const paymentsTabBtn = document.getElementById('payments-tab-btn');
        const notesSection = document.getElementById('notes-section');
        const paymentsSection = document.getElementById('payments-section');

        // Firebase Config & Initialization
        const firebaseConfig = {
            apiKey: "AIzaSyCQ-G2ozgY7TJ6VxLn69y6PzagcOn2Qb6U",
            authDomain: "regiform-lkct3.firebaseapp.com",
            projectId: "regiform-lkct3",
            storageBucket: "regiform-lkct3.firebasestorage.app",
            messagingSenderId: "1028711119142",
            appId: "1:1028711119142:web:cfc2e2a9996f58ed4469e7"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null; // To store the current user

        // Firebase Auth Function
        async function signInAnonymouslyIfNeeded() {
            if (auth.currentUser) {
                currentUser = auth.currentUser;
                console.log("User already signed in:", currentUser.uid);
                return currentUser;
            }
            try {
                const userCredential = await auth.signInAnonymously();
                currentUser = userCredential.user;
                console.log("Signed in anonymously:", currentUser.uid);
                return currentUser;
            } catch (error) {
                console.error("Anonymous sign-in error:", error);
                alert("Could not sign in. Some features might not work. Data will be local.");
                return null;
            }
        }

        // --- FIREBASE DATA FUNCTIONS ---
        async function loadNotesFromFirestore() {
            if (!currentUser) {
                console.warn("No user signed in, cannot load notes from Firestore. Using LocalStorage.");
                loadNotesFromLocalStorage(); // Fallback
                return;
            }
            try {
                const docRef = db.collection('users').doc(currentUser.uid).collection('appData').doc('notesDoc');
                const docSnap = await docRef.get();
                if (docSnap.exists) {
                    state.notes = docSnap.data().notesArray || [];
                    console.log("Notes loaded from Firestore.");
                } else {
                    console.log("No notes document found in Firestore for this user, starting fresh.");
                    state.notes = []; 
                }
            } catch (error) {
                console.error("Error loading notes from Firestore:", error);
                alert("Error al cargar notas desde la nube. Se usarán datos locales si existen.");
                loadNotesFromLocalStorage(); // Fallback on error
            }
        }

        async function loadPaymentsFromFirestore() {
            if (!currentUser) {
                console.warn("No user signed in, cannot load payments from Firestore. Using LocalStorage.");
                loadPaymentsFromLocalStorage(); // Fallback
                return;
            }
            try {
                const docRef = db.collection('users').doc(currentUser.uid).collection('appData').doc('paymentsDoc');
                const docSnap = await docRef.get();
                if (docSnap.exists) {
                    state.payments = docSnap.data().paymentsArray || [];
                    console.log("Payments loaded from Firestore.");
                } else {
                    console.log("No payments document found in Firestore for this user, starting fresh.");
                    state.payments = [];
                }
            } catch (error) {
                console.error("Error loading payments from Firestore:", error);
                alert("Error al cargar pagos desde la nube. Se usarán datos locales si existen.");
                loadPaymentsFromLocalStorage(); // Fallback on error
            }
        }

        async function saveNotesToFirestore() {
            if (!currentUser) {
                console.warn("No user signed in, saving notes to LocalStorage instead.");
                saveNotesToLocalStorage(); // Fallback
                return;
            }
            try {
                const docRef = db.collection('users').doc(currentUser.uid).collection('appData').doc('notesDoc');
                await docRef.set({ notesArray: state.notes });
                console.log("Notes saved to Firestore.");
            } catch (error) {
                console.error("Error saving notes to Firestore:", error);
                alert("Error al guardar notas en la nube. Se intentará guardar localmente.");
                saveNotesToLocalStorage(); // Fallback on error
            }
        }

        async function savePaymentsToFirestore() {
            if (!currentUser) {
                console.warn("No user signed in, saving payments to LocalStorage instead.");
                savePaymentsToLocalStorage(); // Fallback
                return;
            }
            try {
                const docRef = db.collection('users').doc(currentUser.uid).collection('appData').doc('paymentsDoc');
                await docRef.set({ paymentsArray: state.payments });
                console.log("Payments saved to Firestore.");
            } catch (error) {
                console.error("Error saving payments to Firestore:", error);
                alert("Error al guardar pagos en la nube. Se intentará guardar localmente.");
                savePaymentsToLocalStorage(); // Fallback on error
            }
        }

        // --- LOCALSTORAGE UTILS (used for theme, tab, and as fallback for data if Firestore fails/no user) ---
        function saveNotesToLocalStorage() { 
            console.log("Saving notes to LocalStorage (fallback or if no user)");
            localStorage.setItem('notes', JSON.stringify(state.notes)); 
        }
        function loadNotesFromLocalStorage() { 
            console.log("Loading notes from LocalStorage (fallback or if no user)");
            const saved = localStorage.getItem('notes'); 
            if (saved) state.notes = JSON.parse(saved); else state.notes = [];
        }
        function savePaymentsToLocalStorage() { 
            console.log("Saving payments to LocalStorage (fallback or if no user)");
            localStorage.setItem('payments', JSON.stringify(state.payments)); 
        }
        function loadPaymentsFromLocalStorage() { 
            console.log("Loading payments from LocalStorage (fallback or if no user)");
            const saved = localStorage.getItem('payments'); 
            if (saved) state.payments = JSON.parse(saved); else state.payments = [];
        }

        // --- THEME MANAGEMENT ---
        function applyTheme() {
            appElement.setAttribute('data-theme', state.darkMode ? 'dark' : 'light');
            sunIcon.classList.toggle('hidden', !state.darkMode);
            moonIcon.classList.toggle('hidden', state.darkMode);
            localStorage.setItem('darkMode', JSON.stringify(state.darkMode));
        }
        function toggleDarkMode() { state.darkMode = !state.darkMode; applyTheme(); }

        // --- TAB MANAGEMENT ---
        function setActiveTab(tabName) { state.activeTab = tabName; localStorage.setItem('activeTab', tabName); renderApp(); }
        
        // --- UTILITY FUNCTIONS ---
        function formatDate(dateString) {
            if (!dateString) return 'Fecha inválida';
            try {
                const date = dateString.includes('T') ? new Date(dateString) : new Date(dateString + 'T00:00:00');
                return date.toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' });
            } catch (e) { return 'Fecha inválida'; }
        }

        // --- MAIN RENDER FUNCTION ---
        function renderApp() {
            applyTheme();
            notesSection.style.display = state.activeTab === 'notes' ? 'block' : 'none';
            paymentsSection.style.display = state.activeTab === 'payments' ? 'block' : 'none';
            notesSection.classList.toggle('active', state.activeTab === 'notes');
            paymentsSection.classList.toggle('active', state.activeTab === 'payments');
            notesTabBtn.classList.toggle('active', state.activeTab === 'notes');
            paymentsTabBtn.classList.toggle('active', state.activeTab === 'payments');

            if (state.activeTab === 'notes') renderNotesSection();
            else if (state.activeTab === 'payments') renderPaymentsSection();
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        
        // --- NOTES MODULE ---
        function renderNotesSection() {
            let searchInput = document.getElementById('notes-search-input');
            if (!searchInput) {
                notesSection.innerHTML = `
                    <div class="space-y-6">
                        <div class="relative"><i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" style="width:20px;height:20px;"></i><input type="text" id="notes-search-input" placeholder="Buscar notas..." value="${state.searchTerm}" class="w-full pr-4 py-3 rounded-xl border"/></div>
                        <div class="card new-note-card"><h3 class="form-field-title">Nueva Nota</h3><div class="space-y-3"><input type="text" id="new-note-title-input" placeholder="Título de la nota" value="${state.newNote.title}" class="w-full px-4 py-2 rounded-lg border"/><textarea id="new-note-content-input" placeholder="Contenido de la nota" rows="4" class="w-full px-4 py-2 rounded-lg border resize-none">${state.newNote.content}</textarea><button id="add-note-btn" class="action-btn notes-add-btn full-width"><i data-lucide="plus"></i> Agregar Nota</button></div></div>
                        <div id="notes-list-container" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3"></div>
                        <div id="notes-empty-state" class="text-center py-12 hidden"><i data-lucide="file-text" class="mx-auto mb-4 text-gray-400" style="width:48px;height:48px;"></i><p id="notes-empty-state-message" class="text-lg"></p></div>
                    </div>`;
                document.getElementById('notes-search-input').addEventListener('input', (e) => handleSearchTermChange(e.target.value));
                document.getElementById('new-note-title-input').addEventListener('input', (e) => handleNewNoteChange('title', e.target.value));
                document.getElementById('new-note-content-input').addEventListener('input', (e) => handleNewNoteChange('content', e.target.value));
                document.getElementById('add-note-btn').addEventListener('click', addNoteHandler);
            } else {
                document.getElementById('notes-search-input').value = state.searchTerm;
                const newTitleInput = document.getElementById('new-note-title-input');
                const newContentInput = document.getElementById('new-note-content-input');
                if(newTitleInput) newTitleInput.value = state.newNote.title;
                if(newContentInput) newContentInput.value = state.newNote.content;
            }
            renderNotesList(); 
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        function renderNotesList() {
            const listC = document.getElementById('notes-list-container'), emptyEl = document.getElementById('notes-empty-state'), msgEl = document.getElementById('notes-empty-state-message');
            if (!listC || !emptyEl || !msgEl) return;
            const notes = state.notes.filter(n=>(n.title&&n.title.toLowerCase().includes(state.searchTerm.toLowerCase()))||(n.content&&n.content.toLowerCase().includes(state.searchTerm.toLowerCase()))).sort((a,b)=>new Date(b.modifiedAt)-new Date(a.modifiedAt));
            emptyEl.classList.toggle('hidden', notes.length > 0);
            msgEl.textContent = state.searchTerm ? 'No se encontraron notas.' : 'No hay notas aún';
            listC.innerHTML = notes.map(n => {
                const isEd = state.editingNoteId===n.id, cAt=formatDate(n.createdAt), mAt=formatDate(n.modifiedAt), t=n.title||'Sin título',c=n.content||'Sin contenido';
                const dS=isEd&&state.tempEditingNote?state.tempEditingNote.title:t, dC=isEd&&state.tempEditingNote?state.tempEditingNote.content:c;
                return `<div class="note-card group" data-note-id="${n.id}"><div class="note-card-content-wrapper">${isEd?`<div class="space-y-3"><input type="text" value="${dS}" class="w-full px-3 py-2 rounded-lg border editing-note-title-input" oninput="handleTempEditChange('title',this.value)"/><textarea rows="4" class="w-full px-3 py-2 rounded-lg border resize-none editing-note-content-input" oninput="handleTempEditChange('content',this.value)">${dC}</textarea></div>`:`<div class="flex justify-between items-start mb-3"><h4 class="font-semibold text-lg truncate" title="${t}">${t}</h4><div class="flex gap-1 opacity-0 group-hover-opacity-100 transition-opacity note-card-actions"><button class="edit-note-btn" title="Editar" onclick="startEditingNoteHandler(${n.id})"><i data-lucide="edit-3" style="width:16px;height:16px;"></i></button><button class="delete-note-btn delete-action" title="Eliminar" onclick="deleteNoteHandler(${n.id})"><i data-lucide="trash-2" style="width:16px;height:16px;"></i></button></div></div><p class="text-sm mb-4 leading-relaxed note-content-display">${c}</p>`}</div>${isEd?`<div class="flex gap-2 mt-3"><button class="flex-1 bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 save-note-btn" onclick="saveNoteEditHandler(${n.id})"><i data-lucide="save" style="width:16px;height:16px;"></i> Guardar</button><button class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 cancel-edit-note-btn" onclick="cancelNoteEditHandler()"><i data-lucide="x" style="width:16px;height:16px;"></i> Cancelar</button></div>`:`<div class="text-xs text-muted mt-auto pt-2 border-t border-[var(--border-color)]"><p>Creado: ${cAt}</p>${n.modifiedAt&&n.createdAt!==n.modifiedAt?`<p>Modificado: ${mAt}</p>`:''}</div>`}</div>`;}).join('');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        function handleSearchTermChange(v){state.searchTerm=v;renderNotesList();}
        function handleNewNoteChange(f,v){state.newNote[f]=v;}
        async function addNoteHandler(){if(state.newNote.title.trim()||state.newNote.content.trim()){state.notes.unshift({id:Date.now(),title:state.newNote.title.trim()||'Sin título',content:state.newNote.content.trim(),createdAt:new Date().toISOString(),modifiedAt:new Date().toISOString()});state.newNote={title:'',content:''};await saveNotesToFirestore();renderNotesSection();}}
        function startEditingNoteHandler(id){state.editingNoteId=id;const n=state.notes.find(n=>n.id===id);if(n)state.tempEditingNote={...n};renderNotesList();}
        function handleTempEditChange(f,v){if(state.editingNoteId&&state.tempEditingNote)state.tempEditingNote[f]=v;}
        async function saveNoteEditHandler(id){const i=state.notes.findIndex(n=>n.id===id);if(i!==-1&&state.tempEditingNote)state.notes[i]={...state.tempEditingNote,modifiedAt:new Date().toISOString()};state.editingNoteId=null;state.tempEditingNote=null;await saveNotesToFirestore();renderNotesList();}
        function cancelNoteEditHandler(){state.editingNoteId=null;state.tempEditingNote=null;renderNotesList();}
        async function deleteNoteHandler(id){const n=state.notes.find(n=>n.id===id);if(confirm(`¿Estás seguro de que quieres eliminar "${n?n.title:'esta nota'}"?`)){state.notes=state.notes.filter(n=>n.id!==id);if(state.editingNoteId===id){state.editingNoteId=null;state.tempEditingNote=null;}await saveNotesToFirestore();renderNotesList();}}

        // --- PAYMENTS MODULE ---
        function getPaymentSummary() {
            const summary = state.payments.reduce((acc, p) => {
                acc.total += p.totalAmount;
                acc.paid += p.paidAmount;
                if (p.totalAmount > 0 && p.paidAmount >= p.totalAmount) acc.completed++;
                return acc;
            }, { total: 0, paid: 0, completed: 0 });
            summary.remaining = summary.total - summary.paid;
            return summary;
        }

        function renderPaymentsSection() {
            const summary = getPaymentSummary();
            let newPaymentDescInput = document.getElementById('new-payment-description');

            if (!newPaymentDescInput) {
                paymentsSection.innerHTML = `
                    <div class="space-y-6">
                        <div id="payment-summary-container" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="summary-card"><p class="label">Total</p><p class="value total">$0.00</p></div>
                            <div class="summary-card"><p class="label">Pagado</p><p class="value paid">$0.00</p></div>
                            <div class="summary-card"><p class="label">Restante</p><p class="value remaining">$0.00</p></div>
                            <div class="summary-card"><p class="label">Completados</p><p class="value completed">0</p></div>
                        </div>
                        <div id="new-payment-form-container" class="card">
                            <h3 class="form-field-title">Nuevo Pago</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 items-end">
                                <input type="text" id="new-payment-description" placeholder="Descripción" value="${state.newPayment.description}" class="px-4 py-2 rounded-lg border"/>
                                <input type="number" id="new-payment-totalAmount" placeholder="Monto total" value="${state.newPayment.totalAmount}" class="px-4 py-2 rounded-lg border"/>
                                <input type="date" id="new-payment-dueDate" value="${state.newPayment.dueDate}" class="px-4 py-2 rounded-lg border"/>
                                <button id="add-payment-btn" class="action-btn payments-add-btn"><i data-lucide="plus"></i> Agregar</button>
                            </div>
                        </div>
                        <div id="payments-list-container" class="space-y-4"></div>
                        <div id="payments-empty-state" class="text-center py-12 hidden"><i data-lucide="credit-card" class="mx-auto mb-4 text-gray-400" style="width:48px;height:48px;"></i><p id="payments-empty-state-message" class="text-lg"></p></div>
                    </div>`;
                document.getElementById('new-payment-description').addEventListener('input', (e) => handleNewPaymentChange('description', e.target.value));
                document.getElementById('new-payment-totalAmount').addEventListener('input', (e) => handleNewPaymentChange('totalAmount', e.target.value));
                document.getElementById('new-payment-dueDate').addEventListener('input', (e) => handleNewPaymentChange('dueDate', e.target.value));
                document.getElementById('add-payment-btn').addEventListener('click', addPaymentHandler);
            }
            // Update summary values after ensuring elements exist
            const summaryContainer = document.getElementById('payment-summary-container');
            if (summaryContainer) {
                summaryContainer.querySelector('.total').textContent = `$${summary.total.toFixed(2)}`;
                summaryContainer.querySelector('.paid').textContent = `$${summary.paid.toFixed(2)}`;
                summaryContainer.querySelector('.remaining').textContent = `$${summary.remaining.toFixed(2)}`;
                summaryContainer.querySelector('.completed').textContent = summary.completed;
            }
            // Update new payment form input values
            const newPaymentDesc = document.getElementById('new-payment-description');
            const newPaymentTotal = document.getElementById('new-payment-totalAmount');
            const newPaymentDue = document.getElementById('new-payment-dueDate');
            if (newPaymentDesc) newPaymentDesc.value = state.newPayment.description;
            if (newPaymentTotal) newPaymentTotal.value = state.newPayment.totalAmount;
            if (newPaymentDue) newPaymentDue.value = state.newPayment.dueDate;
            
            renderPaymentsList();
            updatePaymentsEmptyState();
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function renderPaymentsList() {
            const listContainer = document.getElementById('payments-list-container');
            if (!listContainer) return;
            const sortedPayments = [...state.payments].sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            listContainer.innerHTML = sortedPayments.map(p => {
                const progress = p.totalAmount > 0 ? (p.paidAmount / p.totalAmount) * 100 : (p.paidAmount > 0 ? 100 :0);
                const isCompleted = p.paidAmount >= p.totalAmount && p.totalAmount > 0;
                const todayDateStr = new Date().toISOString().split('T')[0];
                const isOverdue = p.dueDate < todayDateStr && !isCompleted;
                return `
                    <div class="payment-card ${isOverdue ? 'overdue-border' : ''}" data-payment-id="${p.id}">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1"><div class="flex items-center gap-2 mb-1"><h4 class="font-semibold text-lg">${p.description}</h4>${isCompleted?`<span class="status-badge completed"><i data-lucide="check"></i>Pagado</span>`:''}${isOverdue?`<span class="status-badge overdue">Vencido</span>`:''}</div><p class="text-sm text-muted">Vence: ${formatDate(p.dueDate)}</p></div>
                            <button class="payment-card-delete-btn delete-action" onclick="deletePaymentHandler(${p.id})"><i data-lucide="trash-2"></i></button>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between text-sm"><span>$${p.paidAmount.toFixed(2)} de $${p.totalAmount.toFixed(2)}</span><span>${progress.toFixed(1)}%</span></div>
                            <div class="progress-bar-bg"><div class="progress-bar-fill ${isCompleted?'completed':(isOverdue?'overdue':'')}" style="width:${Math.min(progress,100)}%;"></div></div>
                            ${!isCompleted?`<div class="flex gap-2 items-center"><input type="number" placeholder="Monto a abonar" class="flex-1 payment-abono-input" data-abono-input-for="${p.id}" onkeydown="handleAbonoKeyDown(event, ${p.id})"/><button class="action-btn payment-abono-btn" onclick="addAbonoHandler(${p.id}, this)">Abonar</button></div>`:''}
                        </div>
                    </div>`;
            }).join(''); 
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function updatePaymentsEmptyState() {
            const emptyEl = document.getElementById('payments-empty-state'), msgEl = document.getElementById('payments-empty-state-message');
            if (!emptyEl || !msgEl) return;
            emptyEl.classList.toggle('hidden', state.payments.length > 0);
            if (state.payments.length === 0) msgEl.textContent = 'No hay pagos registrados';
        }

        function handleNewPaymentChange(field, value) { state.newPayment[field] = value; }

        async function addPaymentHandler() {
            const desc = state.newPayment.description.trim();
            const totalAmountStr = state.newPayment.totalAmount;
            const total = parseFloat(totalAmountStr);
            const due = state.newPayment.dueDate;
        
            let isValid = true;
            let validationMessages = []; 
        
            if (!desc) { isValid = false; validationMessages.push("- La descripción es obligatoria."); }
            if (totalAmountStr.trim() === "" || isNaN(total) || total <= 0) { isValid = false; validationMessages.push("- El monto total debe ser un número positivo.");}
            if (!due) { isValid = false; validationMessages.push("- La fecha de vencimiento es obligatoria."); }
        
            if (isValid) {
                state.payments.unshift({id: Date.now(), description: desc, totalAmount: total, paidAmount: 0, dueDate: due, createdAt: new Date().toISOString() });
                state.newPayment = { description: '', totalAmount: '', dueDate: ''}; 
                await savePaymentsToFirestore();
                renderPaymentsSection(); 
            } else {
                alert("Por favor, corrija los siguientes errores:\n" + validationMessages.join("\n"));
            }
        }

        async function addAbonoHandler(paymentId, buttonElement) {
            const inputElement = buttonElement.closest('.flex.gap-2.items-center').querySelector(`input[data-abono-input-for="${paymentId}"]`);
            if (!inputElement) return;
            const amount = parseFloat(inputElement.value);
            if (isNaN(amount) || amount <= 0) { alert("Ingrese un monto válido para abonar."); inputElement.value = ''; return; }
            const payment = state.payments.find(p => p.id === paymentId);
            if (payment) {
                payment.paidAmount = Math.min(payment.totalAmount, payment.paidAmount + amount);
                await savePaymentsToFirestore();
                renderPaymentsSection(); 
            }
            inputElement.value = ''; 
        }
        
        async function handleAbonoKeyDown(event, paymentId) { // Made async as it calls addAbonoHandler
            if (event.key === 'Enter') {
                const inputElement = event.target;
                const abonoButton = inputElement.closest('.flex.gap-2.items-center').querySelector('.payment-abono-btn');
                if (abonoButton) await addAbonoHandler(paymentId, abonoButton); // Await the call
            }
        }

        async function deletePaymentHandler(paymentId) {
            const p = state.payments.find(p => p.id === paymentId);
            if (confirm(`¿Estás seguro de que quieres eliminar el pago "${p ? p.description : 'este pago'}"?`)) {
                state.payments = state.payments.filter(p => p.id !== paymentId);
                await savePaymentsToFirestore();
                renderPaymentsSection();
            }
        }
        function attachPaymentItemListeners() { /* Not currently used */ }

        // --- INITIALIZATION ---
        async function init() {
            currentUser = await signInAnonymouslyIfNeeded(); 
            
            if (currentUser) {
                console.log(`User ${currentUser.uid} signed in. Loading data from Firestore.`);
                await loadNotesFromFirestore();
                await loadPaymentsFromFirestore();
            } else {
                console.warn("Anonymous sign-in failed. Using LocalStorage as fallback for data.");
                loadNotesFromLocalStorage(); 
                loadPaymentsFromLocalStorage();
            }

            const sDarkMode = localStorage.getItem('darkMode');
            state.darkMode = sDarkMode !== null ? JSON.parse(sDarkMode) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
            const sActiveTab = localStorage.getItem('activeTab');
            if (sActiveTab) state.activeTab = sActiveTab;
            
            themeToggleBtn.addEventListener('click', toggleDarkMode);
            notesTabBtn.addEventListener('click', () => setActiveTab('notes'));
            paymentsTabBtn.addEventListener('click', () => setActiveTab('payments'));
            
            document.getElementById('export-data-btn')?.addEventListener('click', () => {
                const dataToExport = {
                    notes: state.notes,
                    payments: state.payments,
                    settings: {darkMode: state.darkMode, activeTab: state.activeTab},
                    exportedAt: new Date().toISOString(),
                    ...(currentUser && {userId: currentUser.uid}) 
                };
                const blob = new Blob([JSON.stringify(dataToExport,null,2)],{type:'application/json'});
                const url = URL.createObjectURL(blob), a = document.createElement('a');
                a.href=url; a.download=`notapay_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
            });
            renderApp(); // This will now render with data from Firestore (or localStorage fallback)
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
